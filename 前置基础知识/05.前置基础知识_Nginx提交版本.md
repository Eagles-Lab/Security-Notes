# 第一章 前置基础知识 - Nginx

## 1. Nginx 功能介绍

在 Web 架构与网络安全领域，Nginx 是使用最广泛的中间件之一，其高性能、高并发特性使其成为企业级应用的 “标配” 组件（如百度、阿里、腾讯等均大规模使用）。掌握 Nginx 的基础功能，是理解 Web 服务部署、反向代理配置及后续安全防护（如 WAF 集成、漏洞防护）的关键前提。

### 1.1 Nginx 介绍

Nginx是由俄罗斯开发者 Igor Sysoev 于 2004 年发布的一款**轻量级、高性能的 HTTP 和反向代理服务器**，同时也支持作为 IMAP/POP3/SMTP 代理服务器。其核心设计目标是解决传统 Web 服务器（如 Apache）在高并发场景下的性能瓶颈 ——Apache 采用 “多进程 / 多线程” 模型，每个连接对应一个进程 / 线程，高并发时会占用大量内存和 CPU 资源；而 Nginx 采用 “异步非阻塞” 模型，单进程可处理数万并发连接，资源占用极低（即使并发量达 10 万，内存占用通常也仅数百 MB）。

目前 Nginx 的应用场景主要包括：



*   作为**Web 服务器**：直接部署静态资源（HTML、CSS、JS、图片等），替代 Apache 处理静态请求；

*   作为**反向代理服务器**：接收客户端请求，转发到后端业务服务器（如 Tomcat、Node.js），实现负载均衡和业务隔离；

*   作为**负载均衡器**：将高并发请求分发到多个后端服务器，避免单点故障，提升服务可用性；

*   作为**API 网关**：统一管理 API 请求，实现请求过滤、身份验证、流量控制等功能；

*   作为**HTTPS 终端**：集中处理 SSL/TLS 加密解密（减少后端服务器的加密开销），配置 SSL 证书实现 HTTPS 访问。

### 1.2 基础特性

Nginx 的流行源于其独特的技术特性，这些特性不仅决定了其高性能优势，也影响后续的安全配置策略：



| 特性              | 说明                                                                            | 安全关联                                                     |
| --------------- | ----------------------------------------------------------------------------- | -------------------------------------------------------- |
| **异步非阻塞 IO 模型** | 基于 epoll（Linux）、kqueue（FreeBSD）等 IO 多路复用技术，单进程可同时处理数千至数万并发连接，无需为每个连接创建进程 / 线程 | 低资源占用降低 “资源耗尽攻击” 的风险，但需合理配置连接数上限，避免被恶意请求占满连接             |
| **轻量级架构**       | 核心代码简洁（仅数万行），运行时内存占用极低（默认配置下，主进程 + 工作进程总内存通常 < 10MB）                          | 代码量少意味着潜在漏洞更少，降低被攻击者利用的概率                                |
| **高可靠性**        | 采用 “主进程 + 工作进程” 的进程模型，工作进程崩溃后，主进程会自动重启新的工作进程，确保服务不中断                          | 避免单点故障导致服务下线，提升攻击后的服务恢复能力                                |
| **跨平台支持**       | 可运行于 Linux、FreeBSD、Windows 等多种操作系统，其中 Linux 平台性能最优（Windows 平台功能受限，不推荐生产使用）    | 生产环境优先选择 Linux，利用 Linux 的安全特性（如 SELinux、防火墙）增强 Nginx 安全性 |
| **热部署能力**       | 支持在不停止服务的情况下，更新配置文件（`nginx -s reload`）、升级 Nginx 版本或更换 SSL 证书                  | 避免配置更新或版本升级时的服务中断，减少 “维护窗口” 带来的安全风险                      |
| **可扩展性**        | 通过模块化设计支持功能扩展，可按需加载官方或第三方模块（如 SSL 模块、缓存模块、WAF 模块）                             | 可集成第三方安全模块（如 ngx\_waf）实现 SQL 注入、XSS 等漏洞防护                |

### 1.3 Web 服务相关的功能

作为 Web 服务器，Nginx 提供了丰富的功能来满足静态资源部署、请求处理及服务优化需求，这些功能也是后续安全配置的重点：



1.  **静态资源处理**

    Nginx 对静态资源（HTML、CSS、JS、图片、视频等）的处理性能远超 Apache，支持：

*   按文件类型设置缓存策略（如对图片设置较长缓存，对 HTML 设置短期缓存）；

*   压缩静态资源（gzip/brotli 压缩），减少传输带宽，提升访问速度；

*   防盗链配置（通过`valid_referers`指令限制资源引用来源，防止他人盗用静态资源）。

1.  **虚拟主机（Virtual Host）**

    支持在同一台服务器上部署多个 Web 站点（如`www.example1.com`和`www.example2.com`），通过 “基于域名”“基于 IP” 或 “基于端口” 的虚拟主机区分不同站点：

*   基于域名：多个域名解析到同一 IP，Nginx 通过`Host`请求头判断访问的站点；

*   基于端口：同一 IP 的不同端口对应不同站点（如 80 端口对应站点 A，8080 端口对应站点 B）；

*   安全意义：实现站点隔离，避免一个站点的漏洞影响其他站点（如站点 A 被入侵后，无法直接访问站点 B 的文件）。

1.  **反向代理与负载均衡**

    这是 Nginx 最核心的功能之一，也是企业级架构的 “标配”：

*   **反向代理**：客户端请求先发送到 Nginx，再由 Nginx 转发到后端业务服务器（如 Tomcat），后端服务器的 IP 不直接暴露给客户端，降低被直接攻击的风险；

*   **负载均衡**：通过`upstream`模块配置多个后端服务器，Nginx 按预设策略（如轮询、权重、IP 哈希）分发请求，实现：


    *   分担后端服务器压力，避免单点过载；

    *   后端服务器故障时自动剔除（健康检查），确保服务可用性；

    *   安全意义：隐藏后端真实 IP，抵御针对后端服务器的直接攻击（如端口扫描、DDoS）。

1.  **HTTPS 与 SSL/TLS 配置**

    支持配置 SSL 证书（如 Let's Encrypt 免费证书、商业 EV 证书），实现 HTTPS 加密传输，核心功能包括：

*   启用 SSL 协议（禁用不安全的 SSLv2/SSLv3，仅保留 TLSv1.2/TLSv1.3）；

*   配置证书链（避免浏览器 “证书不信任” 警告）；

*   启用 HTTP/2（基于 HTTPS，提升并发性能）；

*   配置 HSTS（HTTP Strict Transport Security），强制客户端使用 HTTPS 访问，防止 “降级攻击”。

1.  **请求限制与访问控制**

    提供多种机制保护 Web 服务免受恶意请求攻击：

*   连接限制（`limit_conn_module`）：限制单个 IP 的并发连接数；

*   请求限制（`limit_req_module`）：限制单个 IP 的请求频率（如每秒最多 10 个请求），抵御 CC 攻击；

*   访问控制（`allow/deny`指令）：限制特定 IP 或 IP 段的访问（如仅允许公司内网 IP 访问管理后台）。

## 2. Nginx 架构和进程

Nginx 的高性能与高可靠性，与其独特的 “主从进程” 架构和 “异步非阻塞” 处理模型密切相关。理解其架构和进程机制，是后续排查 Nginx 故障、优化性能及配置安全策略的基础。

### 2.1 Nginx 架构

Nginx 采用 “**模块化、事件驱动**” 的架构，核心由两部分组成：



1.  **核心模块**：Nginx 启动时必须加载的基础模块，负责进程管理、配置解析、网络事件驱动等核心功能（如`core module`、`event module`）；

2.  **功能模块**：按需加载的模块，提供具体功能（如 HTTP 服务、反向代理、负载均衡、SSL 加密等，如`http module`、`stream module`、`upstream module`）；

3.  **事件驱动模型**：基于 IO 多路复用技术（如 Linux 的 epoll），实现 “一个工作进程处理多个并发连接”，避免传统 “一连接一进程” 模型的资源浪费。

Nginx 的架构流程可概括为：



*   启动时，主进程解析配置文件，初始化核心模块和功能模块；

*   主进程创建多个工作进程（数量通常与 CPU 核心数一致，充分利用多核资源）；

*   工作进程通过事件驱动模型，监听并处理客户端连接和请求；

*   所有进程间通过共享内存或信号进行通信，确保配置同步和进程协调。

### 2.2 Nginx 进程结构

Nginx 启动后，系统中会存在两类进程：**主进程（Master Process）** 和**工作进程（Worker Process）**，部分场景下还会存在**缓存加载进程（Cache Loader Process）** 和**缓存管理进程（Cache Manager Process）**（启用缓存时）。

#### 2.2.1 主进程（Master Process）

主进程是 Nginx 的 “管理者”，负责全局控制，不直接处理客户端请求，核心职责包括：



1.  **读取并验证配置文件**（`nginx.conf`）：启动时检查配置文件语法是否正确，若错误则无法启动；

2.  **创建工作进程**：根据配置文件中`worker_processes`指令的设置（默认 1，推荐设置为 CPU 核心数，如`worker_processes 4`），创建对应数量的工作进程；

3.  **管理工作进程**：监控工作进程的运行状态，若工作进程异常退出（如崩溃），主进程会自动创建新的工作进程，确保服务不中断；

4.  **接收并处理信号**：响应管理员发送的信号（如`reload`、`stop`、`restart`），实现配置热更新、服务停止或重启；

*   示例：执行`nginx -s reload`时，主进程会重新读取配置文件，创建新的工作进程，逐步关闭旧的工作进程（确保正在处理的请求不被中断）；

1.  **维护共享内存**：管理 Nginx 的共享内存（如负载均衡的后端服务器状态、缓存数据索引），实现工作进程间的数据共享。

#### 2.2.2 工作进程（Worker Process）

工作进程是 Nginx 的 “执行者”，直接处理客户端的连接和请求，核心职责包括：



1.  **监听端口**：所有工作进程共享主进程创建的监听端口（如 80、443 端口），通过 “惊群避免” 机制（Nginx 已优化）防止多个进程同时争抢一个连接；

2.  **处理请求**：通过事件驱动模型（`epoll`）监听网络事件，当有客户端连接请求时，工作进程会：

*   建立 TCP 连接；

*   读取 HTTP 请求报文；

*   解析请求（如判断虚拟主机、匹配 URL 路径）；

*   处理请求（如返回静态资源、转发到后端服务器）；

*   发送 HTTP 响应报文；

*   关闭 TCP 连接（或保持长连接）；

1.  **资源占用**：工作进程是 “轻量级” 的，每个工作进程仅占用少量内存（通常几 MB 至几十 MB），且无线程切换开销，因此能高效处理数万并发连接。

#### 2.2.3 进程结构示例（Linux 环境）

通过`ps aux | grep nginx`命令可查看 Nginx 的进程列表，典型输出如下：



```
root      1234  0.0  0.1  20528  1648 ?        Ss   10:00   0:00 nginx: master process /usr/sbin/nginx

nginx     1235  0.2  0.5  21040  5120 ?        S    10:00   0:05 nginx: worker process

nginx     1236  0.2  0.5  21040  5080 ?        S    10:00   0:05 nginx: worker process

nginx     1237  0.2  0.5  21040  5100 ?        S    10:00   0:05 nginx: worker process

nginx     1238  0.2  0.5  21040  5096 ?        S    10:00   0:05 nginx: worker process
```



*   主进程（PID 1234）：由`root`用户运行（因需要绑定 80/443 等特权端口，普通用户无权限）；

*   工作进程（PID 1235-1238）：由`nginx`普通用户运行（主进程创建后，会切换到普通用户，降低安全风险 —— 即使工作进程被入侵，也无法获得`root`权限）。

### 2.3 Nginx 进程间通信

Nginx 的主进程与工作进程、工作进程与工作进程之间，通过两种方式实现通信：**信号（Signal）** 和**共享内存（Shared Memory）**。

#### 2.3.1 信号通信（主进程→工作进程）

主进程通过向工作进程发送信号，实现对工作进程的控制，常用信号及作用如下：



| 信号             | 作用                                      | 触发方式                       |
| -------------- | --------------------------------------- | -------------------------- |
| `TERM` / `INT` | 快速停止 Nginx 服务（立即关闭所有进程，正在处理的请求会被中断）     | `nginx -s stop`            |
| `QUIT`         | 优雅停止 Nginx 服务（等待工作进程处理完当前请求后，再关闭进程）     | `nginx -s quit`            |
| `HUP`          | 重新读取配置文件，实现 “热重载”（不中断服务）                | `nginx -s reload`          |
| `USR1`         | 重新打开日志文件（用于日志切割，避免日志文件过大）               | `nginx -s reopen`          |
| `USR2`         | 升级 Nginx 版本（不中断服务，先启动新主进程和新工作进程，再关闭旧进程） | 手动发送：`kill -USR2 主进程PID`   |
| `WINCH`        | 优雅关闭旧工作进程（配合`USR2`实现版本升级）               | 手动发送：`kill -WINCH 旧主进程PID` |

**信号通信流程示例（热重载**`reload`**）**：



1.  管理员执行`nginx -s reload`，向主进程发送`HUP`信号；

2.  主进程接收到`HUP`信号后，重新读取并解析`nginx.conf`配置文件；

3.  若配置文件语法正确，主进程创建新的工作进程（按新配置）；

4.  主进程向旧的工作进程发送`QUIT`信号，通知其处理完当前请求后退出；

5.  旧工作进程处理完所有请求后，自动退出，热重载完成（全程服务不中断）。

#### 2.3.2 共享内存通信（工作进程→工作进程）

工作进程之间通过共享内存实现数据共享，避免每个进程单独存储数据导致的冗余和不一致，主要用于：



*   **负载均衡后端服务器状态**：工作进程共享后端服务器的健康状态（如是否在线、当前连接数），确保所有工作进程按统一的负载均衡策略分发请求；

*   **缓存数据索引**：启用 Nginx 缓存时，工作进程共享缓存数据的索引（如缓存文件路径、过期时间），避免重复缓存相同资源；

*   **请求限制统计**：`limit_req`和`limit_conn`模块通过共享内存统计单个 IP 的请求频率和连接数，确保所有工作进程的统计数据一致（避免单个 IP 通过多个工作进程绕过限制）。

共享内存的大小和用途通过配置文件中的`shared_memory`指令定义，示例：



```
\# 定义名为"limit\_req\_zone"的共享内存，大小10MB，用于请求频率限制

limit\_req\_zone \$binary\_remote\_addr zone=req\_limit:10m rate=10r/s;
```

### 2.4 连接建立和请求处理过程

Nginx 的 “异步非阻塞” 请求处理过程是其高性能的核心，以 “客户端通过 HTTP 访问 Nginx 静态资源” 为例，完整流程如下：

#### 2.4.1 1. TCP 连接建立（三次握手）



1.  客户端（如浏览器）向 Nginx 的监听端口（如 80 端口）发送`SYN`报文，请求建立 TCP 连接；

2.  Nginx 的工作进程通过`epoll`监听端口，检测到新的连接请求后，向客户端发送`SYN+ACK`报文，确认收到连接请求；

3.  客户端向 Nginx 发送`ACK`报文，TCP 连接建立完成。

#### 2.4.2 2. HTTP 请求处理过程



1.  **读取请求报文**：

*   工作进程通过`epoll`监听 TCP 连接的 “读事件”，当客户端发送 HTTP 请求报文时，工作进程读取请求数据；

*   解析请求报文：提取请求行（如`GET /index.html HTTP/1.1`）、请求头（如`Host: ``www.example.com`、`User-Agent: Chrome`）和请求体（GET 请求无请求体）；

*   验证请求合法性：检查请求方法是否支持（如是否允许 POST）、请求头是否完整（如是否包含`Host`头），若不合法则返回 400/405 等错误状态码。

2.  **匹配虚拟主机与请求路径**：

*   Nginx 根据请求头中的`Host`字段（如`www.example.com`），匹配配置文件中`server_name`对应的虚拟主机（`server`块）；

*   若未找到匹配的虚拟主机，会返回默认虚拟主机的响应（或 404 错误，取决于配置）；

*   在匹配的虚拟主机内，根据请求 URI（如`/index.html`），通过`location`指令匹配对应的资源路径规则（如`location / { root /usr/share/nginx/html; }`），确定静态资源的本地存储路径（如`/usr/share/nginx/html/index.html`）。

1.  **处理静态资源请求**：

*   工作进程检查本地文件是否存在（如`/usr/share/nginx/html/index.html`）：


    *   若文件存在：读取文件内容，根据文件类型（如`.html`对应`text/html`）设置`Content-Type`响应头，计算文件大小并设置`Content-Length`头；

    *   若文件不存在：返回 404 错误响应（默认返回 Nginx 的 404 页面，可通过`error_page 404 /404.html;`自定义）；

*   若启用了 gzip 压缩（`gzip on;`），且文件类型符合压缩规则（如`text/html`、`application/javascript`），工作进程会先压缩文件内容再发送，减少传输带宽。

1.  **发送 HTTP 响应报文**：

*   工作进程按 HTTP 协议格式组装响应报文（状态行 + 响应头 + 空行 + 响应体），例如：



```
HTTP/1.1 200 OK

Server: nginx/1.20.1

Date: Wed, 10 Jul 2024 15:30:00 GMT

Content-Type: text/html; charset=utf-8

Content-Length: 1024

Last-Modified: Tue, 09 Jul 2024 10:00:00 GMT

Connection: keep-alive

ETag: "668d7a80-400"

Accept-Ranges: bytes

\<!DOCTYPE html>

\<html>

\<head>\<title>Test Page\</title>\</head>

\<body>Hello Nginx!\</body>

\</html>
```



*   通过已建立的 TCP 连接，将响应报文发送给客户端。

1.  **TCP 连接关闭或复用**：

*   若请求头中`Connection: close`（或 HTTP/1.0 默认），工作进程在发送完响应后，主动关闭 TCP 连接（四次挥手）；

*   若请求头中`Connection: keep-alive`（HTTP/1.1 默认），工作进程会保持 TCP 连接一段时间（由`keepalive_timeout`指令配置，默认 65 秒），等待客户端后续请求（避免重复建立连接的开销）；

*   若超时无新请求，工作进程关闭 TCP 连接。

#### 2.4.3 3. 反向代理场景的请求处理差异

若 Nginx 配置为反向代理（转发请求到后端 Tomcat 服务器），请求处理流程会增加 “转发到后端” 和 “接收后端响应” 两步，具体差异如下：



1.  匹配`location`规则后，Nginx 不读取本地文件，而是根据`proxy_pass`指令（如`proxy_pass http://tomcat_server;`），将请求转发到后端服务器（如`http://192.168.1.100:8080`）；

2.  Nginx 会修改部分请求头（如添加`X-Real-IP`传递客户端真实 IP，添加`X-Forwarded-For`记录代理路径），再将修改后的请求报文发送给后端；

3.  后端服务器处理请求后，返回响应报文给 Nginx；

4.  Nginx 接收后端响应，可根据配置修改响应头（如隐藏后端服务器标识），再将响应转发给客户端。

## 3. Nginx 模块介绍

Nginx 的模块化设计是其功能扩展的核心 —— 通过加载不同模块，可实现静态服务、反向代理、SSL 加密、缓存等多样化功能。理解模块分类和常用模块，是后续自定义配置（如安全加固、性能优化）的基础。

### 3.1 模块分类

按 “是否由 Nginx 官方维护” 和 “功能定位”，Nginx 模块可分为三大类：**核心模块、标准模块、第三方模块**。



| 模块类型                           | 定义                                                    | 特点                                 | 示例                                                                                                     |
| ------------------------------ | ----------------------------------------------------- | ---------------------------------- | ------------------------------------------------------------------------------------------------------ |
| **核心模块（Core Modules）**         | Nginx 启动时必须加载的基础模块，负责进程管理、配置解析、事件驱动等核心逻辑              | 不可卸载，无配置开关，是 Nginx 运行的基础           | `core module`（核心进程管理）、`event module`（事件驱动）、`conf module`（配置解析）                                         |
| **标准模块（Standard Modules）**     | Nginx 官方开发的功能模块，按需加载（编译时默认启用，可通过`--without-module`禁用） | 稳定性高，与 Nginx 版本兼容性好，覆盖绝大多数常用功能     | HTTP 模块（`http module`）、反向代理模块（`proxy module`）、负载均衡模块（`upstream module`）、SSL 模块（`ssl module`）           |
| **第三方模块（Third-Party Modules）** | 由社区或企业开发的扩展模块，需手动下载、编译并集成到 Nginx 中                    | 功能灵活，可满足特殊需求（如 WAF、缓存加速），但稳定性需自行验证 | 安全模块（`ngx_waf`，防 SQL 注入 / XSS）、缓存模块（`ngx_cache_purge`，清理缓存）、监控模块（`ngx_http_stub_status_module`，查看服务状态） |

### 3.2 常用模块及功能说明

#### 3.2.1 核心模块（必须加载）



*   `core module`：最核心的模块，定义 Nginx 的进程模型（主进程 / 工作进程）、配置文件语法规则、基础指令（如`worker_processes`、`worker_connections`、`pid`）；


    *   示例配置：`worker_processes 4;`（设置 4 个工作进程，对应 4 核 CPU）、`worker_connections 10240;`（每个工作进程最大并发连接数 10240）。

*   `event module`：负责事件驱动模型的实现，配置 IO 多路复用方式、连接处理策略；


    *   关键指令：`use epoll;`（Linux 平台推荐使用 epoll IO 模型）、`worker_connections 10240;`（与`core module`配合，限制每个工作进程的连接数）。

#### 3.2.2 标准 HTTP 模块（Web 服务核心）



*   `http module`：HTTP 服务的基础模块，启用 HTTP 协议支持，定义 HTTP 请求的处理框架，包含`server`（虚拟主机）、`location`（路径匹配）等核心配置块；


    *   示例配置：



```
http {

&#x20;   include       mime.types;  # 引入MIME类型映射文件

&#x20;   default\_type  application/octet-stream;

&#x20;   server {

&#x20;       listen       80;  # 监听80端口

&#x20;       server\_name  www.example.com;  # 虚拟主机域名

&#x20;       location / {

&#x20;           root   /usr/share/nginx/html;  # 静态资源根目录

&#x20;           index  index.html index.htm;  # 默认首页

&#x20;       }

&#x20;   }

}
```



*   `proxy module`：实现反向代理功能，将客户端请求转发到后端服务器，支持修改请求头、设置超时时间；


    *   关键指令：`proxy_pass http://backend_server;`（转发请求到后端服务器地址）、`proxy_set_header X-Real-IP $remote_addr;`（传递客户端真实 IP 给后端）、`proxy_connect_timeout 30s;`（后端连接超时时间 30 秒）；

    *   示例配置（转发到 Tomcat）：



```
location /api/ {

&#x20;   proxy\_pass http://192.168.1.100:8080/;  # 后端Tomcat地址

&#x20;   proxy\_set\_header Host \$host;

&#x20;   proxy\_set\_header X-Real-IP \$remote\_addr;

}
```



*   `upstream module`：配合`proxy module`实现负载均衡，定义后端服务器集群（`upstream`块），支持多种负载均衡策略；


    *   常用策略：


        *   轮询（默认）：按顺序分发请求到后端服务器；

        *   权重（`weight`）：权重越高，接收的请求越多（适合后端服务器性能不均场景）；

        *   IP 哈希（`ip_hash`）：按客户端 IP 的哈希值分配后端服务器，确保同一客户端始终访问同一台服务器（解决会话保持问题）；

    *   示例配置（权重 + IP 哈希）：



```
upstream backend\_servers {

&#x20;   ip\_hash;  # 启用IP哈希策略

&#x20;   server 192.168.1.100:8080 weight=3;  # 权重3，接收3/5的请求

&#x20;   server 192.168.1.101:8080 weight=2;  # 权重2，接收2/5的请求

&#x20;   server 192.168.1.102:8080 backup;  # 备用服务器，仅主服务器故障时启用

}

server {

&#x20;   listen 80;

&#x20;   server\_name www.example.com;

&#x20;   location / {

&#x20;       proxy\_pass http://backend\_servers;  # 转发到负载均衡集群

&#x20;   }

}
```



*   `ssl module`：启用 HTTPS 支持，配置 SSL 证书、加密协议、安全套件；


    *   关键指令：`listen 443 ssl;`（监听 443 端口并启用 SSL）、`ssl_certificate cert.pem;`（SSL 证书路径）、`ssl_certificate_key cert.key;`（证书私钥路径）、`ssl_protocols TLSv1.2 TLSv1.3;`（仅启用安全的 TLS 协议，禁用 SSLv2/SSLv3）；

    *   示例配置（HTTPS 启用）：



```
server {

&#x20;   listen 443 ssl;

&#x20;   server\_name www.example.com;

&#x20;   ssl\_certificate /etc/nginx/cert/www.example.com.pem;

&#x20;   ssl\_certificate\_key /etc/nginx/cert/www.example.com.key;

&#x20;   ssl\_protocols TLSv1.2 TLSv1.3;

&#x20;   ssl\_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

&#x20;   location / {

&#x20;       root /usr/share/nginx/html;

&#x20;       index index.html;

&#x20;   }

}
```



*   `limit_req_module`**/**`limit_conn_module`：请求频率限制和并发连接限制模块，抵御 CC 攻击；


    *   示例配置（单 IP 每秒最多 10 个请求，并发连接最多 5 个）：



```
\# 请求频率限制：共享内存10MB，速率10r/s

limit\_req\_zone \$binary\_remote\_addr zone=req\_limit:10m rate=10r/s;

\# 并发连接限制：共享内存10MB，单IP最多5个连接

limit\_conn\_zone \$binary\_remote\_addr zone=conn\_limit:10m;

server {

&#x20;   listen 80;

&#x20;   server\_name www.example.com;

&#x20;   location / {

&#x20;       limit\_req zone=req\_limit burst=20 nodelay;  # 突发请求最多20个，不延迟处理

&#x20;       limit\_conn conn\_limit 5;  # 单IP最多5个并发连接

&#x20;       root /usr/share/nginx/html;

&#x20;   }

}
```

#### 3.2.3 常用第三方模块



*   `ngx_waf`：开源 Web 应用防火墙模块，支持防护 SQL 注入、XSS、文件包含、命令执行等常见 Web 漏洞；


    *   核心功能：基于规则匹配拦截恶意请求，支持自定义规则，可记录攻击日志；

    *   配置示例（启用 WAF 并加载规则）：



```
http {

&#x20;   waf on;

&#x20;   waf\_rule\_path /etc/nginx/waf/rules/;  # WAF规则文件路径

&#x20;   waf\_log /var/log/nginx/waf.log;  # 攻击日志路径

&#x20;   waf\_mode BLOCK;  # 模式：BLOCK（拦截）/LOG（仅日志）

}
```



*   `ngx_http_stub_status_module`：Nginx 服务状态监控模块，可查看当前连接数、请求数、工作进程状态等；


    *   配置示例（启用状态页）：



```
server {

&#x20;   listen 80;

&#x20;   server\_name www.example.com;

&#x20;   location /nginx\_status {

&#x20;       stub\_status on;

&#x20;       allow 192.168.1.0/24;  # 仅允许内网IP访问状态页

&#x20;       deny all;  # 拒绝其他IP

&#x20;   }

}
```



*   访问`http://www.example.com/nginx_status`，返回状态信息如下：



```
Active connections: 23

server accepts handled requests

&#x20;12345 12345 67890

Reading: 0 Writing: 10 Waiting: 13
```



*   `Active connections`：当前活跃连接数；

*   `accepts`：总接受连接数；

*   `handled`：总处理连接数；

*   `requests`：总请求数；

*   `Reading`：正在读取请求的连接数；

*   `Writing`：正在发送响应的连接数；

*   `Waiting`：等待请求的空闲连接数（长连接）。
## 4. Nginx 安装（Linux 环境，两种主流方式）

Nginx 的安装方式主要分为 “基于 yum 安装”（适合快速部署，版本固定）和 “编译安装”（适合自定义模块、指定版本），以下以 CentOS 7 为例，详细说明两种安装步骤（生产环境推荐使用 Linux，Windows 仅用于测试）。

### 4.1 基于 yum 安装 Nginx（快速部署）

yum 安装依赖 CentOS 的官方仓库或 Nginx 官方仓库，步骤简单，适合对版本无特殊要求的场景。

#### 4.1.1 步骤 1：配置 Nginx 官方 yum 仓库

CentOS 官方仓库中的 Nginx 版本较旧，推荐添加 Nginx 官方仓库以获取最新稳定版：



1.  创建 Nginx 仓库文件：



```
sudo vi /etc/yum.repos.d/nginx.repo
```



1.  粘贴以下内容（Nginx 官方仓库配置，适用于 CentOS 7）：



```
\[nginx-stable]

name=nginx stable repo

baseurl=http://nginx.org/packages/centos/7/\$basearch/

gpgcheck=1

enabled=1

gpgkey=https://nginx.org/keys/nginx\_signing.key

module\_hotfixes=true

\[nginx-mainline]

name=nginx mainline repo

baseurl=http://nginx.org/packages/mainline/centos/7/\$basearch/

gpgcheck=1

enabled=0

gpgkey=https://nginx.org/keys/nginx\_signing.key

module\_hotfixes=true
```



*   `nginx-stable`：稳定版（推荐生产使用）；

*   `nginx-mainline`：开发版（含最新功能，稳定性稍低，默认禁用）。

1.  保存并退出 vi：按`Esc`，输入`:wq`，回车。

#### 4.1.2 步骤 2：安装 Nginx



1.  清理 yum 缓存并更新仓库：



```
sudo yum clean all && sudo yum makecache fast
```



1.  安装 Nginx：



```
sudo yum install -y nginx
```



1.  验证安装：



```
nginx -v  # 查看Nginx版本，如输出"nginx version: nginx/1.24.0"表示安装成功
```

#### 4.1.3 步骤 3：启动 Nginx 并设置开机自启



1.  启动 Nginx 服务：



```
sudo systemctl start nginx
```



1.  验证服务状态（若显示 “active (running)”，表示启动成功）：



```
sudo systemctl status nginx
```



1.  设置开机自启（避免服务器重启后 Nginx 未启动）：



```
sudo systemctl enable nginx
```
#### 4.1.4 步骤 4：验证 Nginx 服务与配置文件路径



1.  **访问 Nginx 默认页面验证服务**：

*   若服务器开启了防火墙，需开放 80 端口（HTTP 默认端口）：



```
sudo firewall-cmd --add-port=80/tcp --permanent  # 永久开放80端口

sudo firewall-cmd --reload  # 重载防火墙规则
```



*   在浏览器中输入服务器 IP 地址（如`http://192.168.1.200`），若显示 Nginx 默认欢迎页面（含 “Welcome to nginx!” 字样），表示服务正常运行。

1.  **了解 yum 安装的关键文件路径**（后续配置修改需用到）：



| 文件 / 目录路径                | 作用                                                                               |
| ------------------------ | -------------------------------------------------------------------------------- |
| `/etc/nginx/nginx.conf`  | Nginx 主配置文件（核心配置，包含全局设置、HTTP 块、默认虚拟主机）                                           |
| `/etc/nginx/conf.d/`     | 额外配置文件目录（推荐将虚拟主机配置放在此目录，以`.conf`结尾，主配置文件通过`include /etc/nginx/conf.d/*.conf;`加载） |
| `/usr/share/nginx/html/` | 默认静态资源根目录（Nginx 默认页面存放位置，可通过`root`指令修改）                                          |
| `/var/log/nginx/`        | 日志目录（`access.log`为访问日志，记录所有客户端请求；`error.log`为错误日志，记录服务异常信息）                      |
| `/usr/sbin/nginx`        | Nginx 可执行文件路径（用于执行启动、重载、停止等命令）                                                   |
| `/var/run/nginx.pid`     | Nginx 进程 PID 文件（记录主进程 PID，用于信号通信）                                                |



1.  **基础配置修改示例（自定义静态页面）**：

*   编辑默认静态页面：



```
sudo vi /usr/share/nginx/html/index.html
```



*   将默认内容替换为自定义 HTML（如`<h1>My First Nginx Page</h1>`），保存退出；

*   刷新浏览器访问服务器 IP，即可看到修改后的页面（无需重启 Nginx，静态文件修改实时生效）。

### 4.2 编译安装 Nginx（自定义部署）

编译安装适合需要 “指定 Nginx 版本”“集成第三方模块”（如`ngx_waf`）或 “自定义安装路径” 的场景，步骤较 yum 安装复杂，但灵活性更高。以下以 “安装 Nginx 1.24.0 并集成`ngx_http_stub_status_module`监控模块” 为例，详细说明步骤。

#### 4.2.1 步骤 1：安装编译依赖

编译 Nginx 需依赖编译器、库文件等工具，执行以下命令安装：



```
\# 安装gcc编译器（编译C语言代码）

sudo yum install -y gcc gcc-c++

\# 安装PCRE库（支持正则表达式，Nginx的location匹配依赖）

sudo yum install -y pcre pcre-devel

\# 安装zlib库（支持gzip压缩，Nginx的gzip模块依赖）

sudo yum install -y zlib zlib-devel

\# 安装OpenSSL库（支持SSL/TLS，Nginx的HTTPS功能依赖）

sudo yum install -y openssl openssl-devel

\# 安装wget（用于下载Nginx源码包）

sudo yum install -y wget
```

#### 4.2.2 步骤 2：下载 Nginx 源码包



1.  进入临时目录（如`/tmp`），下载 Nginx 1.24.0 源码包（官方下载地址：[https://nginx.org/en/download.html](https://nginx.org/en/download.html)）：



```
cd /tmp

wget https://nginx.org/download/nginx-1.24.0.tar.gz
```



1.  解压源码包：



```
tar -zxvf nginx-1.24.0.tar.gz
```

解压后会生成`nginx-1.24.0`目录，进入该目录准备编译：



```
cd nginx-1.24.0
```

#### 4.2.3 步骤 3：配置编译参数（核心步骤）

通过`./configure`命令配置编译参数，核心参数包括 “安装路径”“启用 / 禁用模块”“依赖库路径” 等。本次配置 “自定义安装路径为`/usr/local/nginx`” 并 “启用`ngx_http_stub_status_module`监控模块”，命令如下：



```
./configure \\

\--prefix=/usr/local/nginx \  # 自定义安装路径（推荐路径，便于管理）

\--user=nginx \  # 工作进程运行用户（后续创建，避免root权限）

\--group=nginx \  # 工作进程运行用户组

\--with-http\_ssl\_module \  # 启用SSL模块（支持HTTPS）

\--with-http\_stub\_status\_module \  # 启用监控模块（查看服务状态）

\--with-pcre \  # 指定使用系统PCRE库

\--with-zlib \  # 指定使用系统zlib库

\--with-openssl \  # 指定使用系统OpenSSL库

\--http-log-path=/var/log/nginx/access.log \  # 访问日志路径

\--error-log-path=/var/log/nginx/error.log \  # 错误日志路径

\--pid-path=/var/run/nginx.pid  # PID文件路径
```



*   配置过程中若出现 “error: ... not found” 报错，通常是依赖库未安装，需补充安装对应依赖（如`pcre-devel`未装会报 “pcre library not found”）；

*   配置成功后，终端会显示 “Configuration summary”，列出安装路径、模块等信息。

#### 4.2.4 步骤 4：编译与安装



1.  执行`make`命令编译源码（编译过程需 1-5 分钟，取决于服务器性能）：



```
make
```



*   若编译失败，需根据终端报错信息排查（如依赖缺失、参数错误），修复后重新执行`make`；

*   若需清理编译缓存（如修改编译参数后），可执行`make clean`。

1.  执行`make install`命令安装编译后的文件到指定路径（`/usr/local/nginx`）：



```
sudo make install
```

安装成功后，`/usr/local/nginx`目录下会生成 4 个子目录：



*   `sbin/`：存放 Nginx 可执行文件（`nginx`）；

*   `conf/`：存放配置文件（`nginx.conf`为主配置文件）；

*   `html/`：存放默认静态资源；

*   `logs/`：默认日志目录（后续可通过配置修改为`/var/log/nginx`）。

#### 4.2.5 步骤 5：创建 Nginx 运行用户与环境变量



1.  **创建 nginx 用户（避免工作进程用 root 运行，降低安全风险）**：



```
sudo useradd -r -m -s /sbin/nologin nginx
```



*   `-r`：创建系统用户；

*   `-m`：创建用户家目录；

*   `-s /sbin/nologin`：禁止用户登录系统（仅用于运行 Nginx 进程）。

1.  **配置环境变量（便于在任意目录执行 nginx 命令）**：

*   编辑`/etc/profile`文件，添加 Nginx 可执行文件路径到`PATH`：



```
sudo vi /etc/profile
```



*   在文件末尾添加以下内容：



```
export PATH=\$PATH:/usr/local/nginx/sbin
```



*   保存退出后，执行以下命令使环境变量立即生效：



```
source /etc/profile
```

#### 4.2.6 步骤 6：启动 Nginx 并验证



1.  **验证配置文件语法（启动前必做，避免配置错误导致启动失败）**：



```
nginx -t
```



*   若显示 “nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful”，表示配置文件语法正确；

*   若显示错误（如 “unknown directive”），需编辑`/usr/local/nginx/conf/nginx.conf`修复。

1.  **启动 Nginx 服务**：



```
sudo nginx
```



*   启动后，执行`ps aux | grep nginx`查看进程，应能看到 “主进程（root 用户）+ 工作进程（nginx 用户）”；

*   若需停止 Nginx：`sudo nginx -s stop`（快速停止）或`sudo nginx -s quit`（优雅停止）；

*   若需重载配置：`sudo nginx -s reload`（修改配置后无需重启服务）。

1.  **设置开机自启（通过 systemd 服务管理，与 yum 安装一致）**：

*   创建 systemd 服务文件：



```
sudo vi /usr/lib/systemd/system/nginx.service
```



*   粘贴以下内容（适配编译安装路径）：



```
\[Unit]

Description=The NGINX HTTP and reverse proxy server

After=network.target remote-fs.target nss-lookup.target

\[Service]

Type=forking

PIDFile=/var/run/nginx.pid

ExecStartPre=/usr/local/nginx/sbin/nginx -t -q -g 'daemon on; master\_process on;'

ExecStart=/usr/local/nginx/sbin/nginx -g 'daemon on; master\_process on;'

ExecReload=/usr/local/nginx/sbin/nginx -g 'daemon on; master\_process on;' -s reload

ExecStop=-/sbin/start-stop-daemon --quiet --stop --retry QUIT/5 --pidfile /var/run/nginx.pid

TimeoutStopSec=5

KillMode=mixed

\[Install]

WantedBy=multi-user.target
```



*   保存退出后，重新加载 systemd 配置：



```
sudo systemctl daemon-reload
```



*   设置开机自启并验证：



```
sudo systemctl enable nginx

sudo systemctl status nginx  # 确认服务状态为active (running)
```



1.  **验证监控模块（因编译时启用了**`ngx_http_stub_status_module`**）**：

*   编辑主配置文件，添加监控页面配置：



```
sudo vi /usr/local/nginx/conf/nginx.conf
```



*   在`http`块的`server`块内添加以下内容：



```
location /nginx\_status {

&#x20;   stub\_status on;

&#x20;   allow 192.168.1.0/24;  # 仅允许内网IP访问

&#x20;   deny all;

}
```



*   重载配置：`sudo nginx -s reload`；

*   在浏览器中访问`http://服务器IP/nginx_status`，应能看到 Nginx 服务状态信息（如活跃连接数、总请求数），验证监控模块生效。

### 4.3 两种安装方式对比与选择建议



| 对比维度  | yum 安装                            | 编译安装                              |
| ----- | --------------------------------- | --------------------------------- |
| 操作复杂度 | 简单（3-5 步完成）                       | 复杂（需安装依赖、配置参数、编译）                 |
| 版本灵活性 | 固定（仓库提供的版本，更新较慢）                  | 灵活（可指定任意官方版本）                     |
| 模块定制  | 仅支持官方默认模块（无法集成第三方模块）              | 支持自定义模块（可集成`ngx_waf`等第三方模块）       |
| 路径管理  | 系统默认路径（如`/etc/nginx`），符合 Linux 规范 | 自定义路径（如`/usr/local/nginx`），便于统一管理 |
| 升级难度  | 简单（`sudo yum update nginx`）       | 复杂（需重新下载源码、编译、安装，需注意配置文件备份）       |
| 适用场景  | 快速部署、测试环境、对版本 / 模块无特殊要求的生产环境      | 需指定版本、集成第三方模块（如 WAF）、自定义路径的生产环境   |

**选择建议**：



*   若为测试环境或快速验证 Nginx 功能，优先选择 yum 安装；

*   若为生产环境且需启用 HTTPS、监控模块，或需集成 WAF 等第三方模块，必须选择编译安装；

*   企业级生产环境推荐 “编译安装 + 自定义路径 + systemd 管理”，便于后续维护与安全加固。
