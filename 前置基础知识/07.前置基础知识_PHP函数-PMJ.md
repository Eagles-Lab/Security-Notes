# PHP函数

## 一、PHP函数概述：代码复用与功能模块化

### 1.1 什么是PHP函数？

PHP函数是一段被命名的、可重复使用的代码块，能够接收输入参数、执行特定任务并返回结果。函数是程序设计中实现代码复用、提高开发效率、降低维护成本的重要工具。

在网络安全领域，函数的正确使用关系到应用程序的安全性：
- **输入验证函数**：确保用户输入的合法性
- **输出过滤函数**：防止XSS攻击
- **数据处理函数**：安全地处理敏感数据
- **权限验证函数**：控制用户访问权限

### 1.2 PHP函数的分类

| 函数类型 | 说明 | 示例 | 安全特点 |
|----------|------|------|----------|
| **内置函数** | PHP内置提供的函数 | `strlen()`, `mysql_connect()` | 部分函数存在安全风险，需要谨慎使用 |
| **用户定义函数** | 开发者自定义的函数 | `validateInput()`, `sanitizeData()` | 安全性完全取决于实现质量 |
| **匿名函数** | 没有名称的函数（闭包） | `function() { ... }` | 常用于回调，注意作用域安全 |
| **可变函数** | 通过变量调用的函数 | `$func = 'strlen'; $func();` | ⚠️ 高风险，可能导致任意代码执行 |

## 二、PHP用户定义函数

### 2.1 函数定义语法

PHP用户定义函数使用 `function` 关键字定义，基本语法如下：

```php
<?php
function 函数名(参数列表) {
    // 函数体
    return 返回值; // 可选
}
?>
```

#### 2.1.1 基本函数示例

```php
<?php
    // 简单的问候函数
    function greet($name) {
        return "Hello, " . $name . "!";
    }
    
    // 调用函数
    echo greet("Alice"); // 输出: Hello, Alice!
    
    // 安全的用户输入验证函数
    function validateUsername($username) {
        // 检查是否为空
        if (empty($username)) {
            return false;
        }
        
        // 检查长度
        if (strlen($username) < 3 || strlen($username) > 20) {
            return false;
        }
        
        // 检查字符是否合法（只允许字母、数字、下划线）
        if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {
            return false;
        }
        
        return true;
    }
    
    // 使用示例
    $userInput = "admin_123";
    if (validateUsername($userInput)) {
        echo "用户名验证通过";
    } else {
        echo "用户名格式不正确";
    }
?>
```

### 2.2 函数命名规范

良好的函数命名是代码可读性和安全性的基础：

| 命名类型 | 示例 | 说明 | 安全建议 |
|----------|------|------|----------|
| **动作型** | `validateInput()`, `sanitizeData()` | 表示执行的动作 | 函数名应明确表示功能，避免歧义 |
| **判断型** | `isAdmin()`, `hasPermission()` | 返回布尔值的判断 | 以is、has、can等开头，明确返回类型 |
| **获取型** | `getUserInfo()`, `getConfig()` | 获取数据 | 明确获取的数据类型和来源 |
| **处理型** | `processPayment()`, `encryptPassword()` | 处理业务逻辑 | 函数名应反映处理的安全性质 |

### 2.3 函数的安全设计原则

#### 2.3.1 输入验证原则

```php
<?php
    // 安全的邮箱验证函数
    function validateEmail($email) {
        // 1. 基础验证
        if (empty($email)) {
            return false;
        }
        
        // 2. 格式验证
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            return false;
        }
        
        // 3. 长度限制
        if (strlen($email) > 254) {
            return false;
        }
        
        // 4. 域名白名单（可选）
        $allowedDomains = ['gmail.com', 'yahoo.com', 'outlook.com'];
        $domain = substr(strrchr($email, "@"), 1);
        if (!empty($allowedDomains) && !in_array($domain, $allowedDomains, true)) {
            return false;
        }
        
        return true;
    }
    
    // 安全的密码强度验证函数
    function validatePasswordStrength($password) {
        $result = [
            'valid' => false,
            'score' => 0,
            'messages' => []
        ];
        
        // 长度检查
        if (strlen($password) < 8) {
            $result['messages'][] = '密码长度至少8位';
            return $result;
        } else {
            $result['score'] += 1;
        }
        
        // 复杂度检查
        if (preg_match('/[a-z]/', $password)) $result['score'] += 1; // 小写字母
        if (preg_match('/[A-Z]/', $password)) $result['score'] += 1; // 大写字母
        if (preg_match('/[0-9]/', $password)) $result['score'] += 1; // 数字
        if (preg_match('/[^a-zA-Z0-9]/', $password)) $result['score'] += 1; // 特殊字符
        
        // 评分
        if ($result['score'] >= 3) {
            $result['valid'] = true;
            $result['messages'][] = '密码强度良好';
        } else {
            $result['messages'][] = '密码需要包含大小写字母、数字和特殊字符';
        }
        
        return $result;
    }
?>
```

## 三、PHP函数参数

### 3.1 参数传递方式

PHP支持多种参数传递方式，每种方式都有其特定的使用场景和安全考虑。

#### 3.1.1 值传递（默认方式）

```php
<?php
    // 值传递 - 传递参数的副本
    function processValue($data) {
        $data = strtoupper($data); // 修改不影响原变量
        return $data;
    }
    
    $original = "hello world";
    $result = processValue($original);
    
    echo "原始值: $original\n";    // 输出: hello world
    echo "处理结果: $result\n";     // 输出: HELLO WORLD
?>
```

#### 3.1.2 引用传递

```php
<?php
    // 引用传递 - 传递变量的引用
    function processReference(&$data) {
        $data = strtoupper($data); // 修改会影响原变量
    }
    
    $original = "hello world";
    processReference($original);
    
    echo "处理后: $original\n";     // 输出: HELLO WORLD
    
    // 安全的数组清理函数（使用引用传递）
    function sanitizeArrayInPlace(&$array) {
        foreach ($array as $key => &$value) {
            if (is_string($value)) {
                $value = htmlspecialchars(trim($value), ENT_QUOTES, 'UTF-8');
            } elseif (is_array($value)) {
                sanitizeArrayInPlace($value); // 递归处理嵌套数组
            }
        }
    }
    
    // 使用示例
    $userInput = [
        'name' => '  <script>alert("XSS")</script>  ',
        'email' => 'test@example.com',
        'profile' => [
            'bio' => '<img src=x onerror=alert(1)>',
            'website' => 'http://example.com'
        ]
    ];
    
    sanitizeArrayInPlace($userInput);
    print_r($userInput); // 输出清理后的数组
?>
```

### 3.2 类型声明（PHP 7+）

PHP 7引入了标量类型声明，提高了代码的安全性和可读性：

```php
<?php
    // 启用严格模式
    declare(strict_types=1);
    
    // 标量类型声明
    function calculateAge(int $birthYear, int $currentYear): int {
        if ($birthYear > $currentYear) {
            throw new InvalidArgumentException('出生年份不能大于当前年份');
        }
        
        if ($birthYear < 1900) {
            throw new InvalidArgumentException('出生年份不能小于1900年');
        }
        
        return $currentYear - $birthYear;
    }
    
    // 数组类型声明
    function processUserRoles(array $roles): array {
        $allowedRoles = ['admin', 'editor', 'viewer'];
        $validRoles = [];
        
        foreach ($roles as $role) {
            if (in_array($role, $allowedRoles, true)) {
                $validRoles[] = $role;
            }
        }
        
        return $validRoles;
    }
    
    // 使用示例
    try {
        $age = calculateAge(1990, 2024);
        echo "年龄: $age\n";
        
        $userRoles = processUserRoles(['admin', 'hacker', 'editor']);
        print_r($userRoles); // 输出: ['admin', 'editor']
    } catch (Exception $e) {
        echo "错误: " . $e->getMessage();
    }
?>
```

### 3.3 可变参数列表

PHP支持可变数量的参数，这在处理不确定数量的输入时很有用：

```php
<?php
    // 使用 func_get_args() 获取所有参数
    function logMessage($level) {
        $args = func_get_args();
        $level = array_shift($args); // 移除第一个参数（级别）
        
        $message = "[" . strtoupper($level) . "] " . implode(" ", $args);
        echo $message . "\n";
    }
    
    // PHP 5.6+ 使用 ... 操作符
    function secureLog(string $level, ...$messages): void {
        // 过滤敏感信息
        $filteredMessages = [];
        $sensitivePatterns = ['/password\s*[:=]\s*\S+/i', '/api_key\s*[:=]\s*\S+/i'];
        
        foreach ($messages as $message) {
            foreach ($sensitivePatterns as $pattern) {
                $message = preg_replace($pattern, '[FILTERED]', $message);
            }
            $filteredMessages[] = $message;
        }
        
        $logEntry = "[" . strtoupper($level) . "] " . implode(" ", $filteredMessages);
        error_log($logEntry);
        echo $logEntry . "\n";
    }
    
    // 使用示例
    logMessage('info', '用户登录', 'IP: 192.168.1.100', 'User: admin');
    secureLog('debug', '数据库连接', 'password: secret123', 'api_key: abc123');
?>
```

## 四、PHP默认参数

### 4.1 默认参数的使用

默认参数允许函数在调用时省略某些参数，提高函数的灵活性：

```php
<?php
    // 基本默认参数
    function createUser($username, $email, $role = 'user', $status = 'active') {
        return [
            'username' => $username,
            'email' => $email,
            'role' => $role,
            'status' => $status,
            'created_at' => date('Y-m-d H:i:s')
        ];
    }
    
    // 不同的调用方式
    $user1 = createUser('alice', 'alice@example.com');
    $user2 = createUser('bob', 'bob@example.com', 'admin');
    $user3 = createUser('charlie', 'charlie@example.com', 'editor', 'pending');
    
    print_r($user1);
    print_r($user2);
    print_r($user3);
?>
```

### 4.2 安全的默认参数设计

```php
<?php
    // 安全的文件上传处理函数
    function processFileUpload($file, $allowedTypes = ['jpg', 'png', 'gif'], $maxSize = 2097152, $uploadDir = './uploads/') {
        $result = [
            'success' => false,
            'message' => '',
            'filename' => null
        ];
        
        // 验证文件是否上传成功
        if (!isset($file['tmp_name']) || $file['error'] !== UPLOAD_ERR_OK) {
            $result['message'] = '文件上传失败';
            return $result;
        }
        
        // 验证文件大小
        if ($file['size'] > $maxSize) {
            $result['message'] = '文件大小超过限制';
            return $result;
        }
        
        // 获取文件扩展名
        $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
        
        // 验证文件类型
        if (!in_array($extension, $allowedTypes, true)) {
            $result['message'] = '不允许的文件类型';
            return $result;
        }
        
        // 生成安全的文件名
        $filename = uniqid('upload_') . '.' . $extension;
        $filepath = $uploadDir . $filename;
        
        // 移动文件
        if (move_uploaded_file($file['tmp_name'], $filepath)) {
            $result['success'] = true;
            $result['message'] = '文件上传成功';
            $result['filename'] = $filename;
        } else {
            $result['message'] = '文件保存失败';
        }
        
        return $result;
    }
    
    // 安全的文件处理函数  
    function readSecureFile($filename, $maxSize = 1048576) { // 1MB限制
        // 验证文件名安全性
        if (!preg_match('/^[a-zA-Z0-9._-]+$/', $filename)) {
            throw new InvalidArgumentException('文件名包含非法字符');
        }
        
        // 限制文件路径（防止路径遍历）
        $safePath = __DIR__ . '/uploads/' . basename($filename);
        
        if (!file_exists($safePath)) {
            throw new Exception('文件不存在');
        }
        
        if (filesize($safePath) > $maxSize) {
            throw new Exception('文件大小超出限制');
        }
        
        return file_get_contents($safePath);
    }
?>
```

## 五、函数返回值

### 5.1 返回值类型

PHP函数可以返回各种类型的数据，正确处理返回值对程序的安全性至关重要：

```php
<?php
    // 返回不同类型的数据
    function getSystemInfo(): array {
        return [
            'php_version' => PHP_VERSION,
            'server_software' => $_SERVER['SERVER_SOFTWARE'] ?? 'Unknown',
            'memory_limit' => ini_get('memory_limit'),
            'max_execution_time' => ini_get('max_execution_time')
        ];
    }
    
    // 返回状态和数据
    function authenticateUser($username, $password): array {
        // 模拟用户数据
        $users = [
            'admin' => password_hash('admin123', PASSWORD_DEFAULT),
            'user' => password_hash('user123', PASSWORD_DEFAULT)
        ];
        
        // 输入验证
        if (empty($username) || empty($password)) {
            return [
                'success' => false,
                'message' => '用户名和密码不能为空',
                'user' => null
            ];
        }
        
        // 检查用户是否存在
        if (!isset($users[$username])) {
            return [
                'success' => false,
                'message' => '用户不存在',
                'user' => null
            ];
        }
        
        // 验证密码
        if (password_verify($password, $users[$username])) {
            return [
                'success' => true,
                'message' => '登录成功',
                'user' => [
                    'username' => $username,
                    'login_time' => time()
                ]
            ];
        } else {
            return [
                'success' => false,
                'message' => '密码错误',
                'user' => null
            ];
        }
    }
?>
```

### 5.2 错误处理和返回值

```php
<?php
    // 使用异常处理的安全函数
    class SecurityException extends Exception {}
    
    function validateAndSanitizeInput($input, $type = 'string', $options = []) {
        try {
            if ($input === null || $input === '') {
                if ($options['required'] ?? false) {
                    throw new SecurityException('Required field cannot be empty');
                }
                return null;
            }
            
            switch ($type) {
                case 'email':
                    if (!filter_var($input, FILTER_VALIDATE_EMAIL)) {
                        throw new SecurityException('Invalid email format');
                    }
                    return filter_var($input, FILTER_SANITIZE_EMAIL);
                    
                case 'int':
                    $min = $options['min'] ?? null;
                    $max = $options['max'] ?? null;
                    
                    if (!filter_var($input, FILTER_VALIDATE_INT)) {
                        throw new SecurityException('Invalid integer format');
                    }
                    
                    $value = (int)$input;
                    if ($min !== null && $value < $min) {
                        throw new SecurityException("Value must be at least $min");
                    }
                    if ($max !== null && $value > $max) {
                        throw new SecurityException("Value must be at most $max");
                    }
                    
                    return $value;
                    
                case 'string':
                default:
                    $maxLength = $options['max_length'] ?? 255;
                    $input = trim($input);
                    
                    if (strlen($input) > $maxLength) {
                        throw new SecurityException("String too long (max $maxLength characters)");
                    }
                    
                    return htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
            }
        } catch (Exception $e) {
            error_log("Input validation error: " . $e->getMessage());
            throw $e;
        }
    }
    
    // 使用示例
    try {
        $email = validateAndSanitizeInput('test@example.com', 'email');
        $age = validateAndSanitizeInput('25', 'int', ['min' => 0, 'max' => 150]);
        $name = validateAndSanitizeInput('<script>alert("xss")</script>', 'string', ['max_length' => 50]);
        
        echo "Email: $email\n";
        echo "Age: $age\n";
        echo "Name: $name\n";
    } catch (SecurityException $e) {
        echo "安全错误: " . $e->getMessage();
    }
?>
```

## 六、匿名函数（闭包）

### 6.1 匿名函数基础

匿名函数（也叫闭包）是没有名称的函数，通常用于回调和一次性使用的场景：

```php
<?php
    // 基本匿名函数
    $greeting = function($name) {
        return "Hello, $name!";
    };
    
    echo $greeting("Alice"); // 输出: Hello, Alice!
    
    // 数组处理中的匿名函数
    $numbers = [1, 2, 3, 4, 5];
    
    // 使用array_map和匿名函数
    $squares = array_map(function($n) {
        return $n * $n;
    }, $numbers);
    
    print_r($squares); // [1, 4, 9, 16, 25]
    
    // 使用array_filter过滤数据
    $evenNumbers = array_filter($numbers, function($n) {
        return $n % 2 === 0;
    });
    
    print_r($evenNumbers); // [2, 4]
?>
```

### 6.2 use关键字和变量捕获

```php
<?php
    // 使用use捕获外部变量
    $multiplier = 3;
    $prefix = "Result: ";
    
    $calculator = function($number) use ($multiplier, $prefix) {
        return $prefix . ($number * $multiplier);
    };
    
    echo $calculator(5); // 输出: Result: 15
    
    // 引用捕获（修改外部变量）
    $counter = 0;
    
    $increment = function() use (&$counter) {
        $counter++;
        return $counter;
    };
    
    echo $increment(); // 1
    echo $increment(); // 2
    echo $counter;     // 2
?>
```

### 6.3 闭包在安全编程中的应用

```php
<?php
    // 安全的数据验证器工厂
    function createValidator($rules) {
        return function($data) use ($rules) {
            $errors = [];
            
            foreach ($rules as $field => $rule) {
                $value = $data[$field] ?? null;
                
                // 必填验证
                if (isset($rule['required']) && $rule['required'] && empty($value)) {
                    $errors[$field][] = "$field is required";
                    continue;
                }
                
                if (!empty($value)) {
                    // 类型验证
                    if (isset($rule['type'])) {
                        switch ($rule['type']) {
                            case 'email':
                                if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                                    $errors[$field][] = "$field must be a valid email";
                                }
                                break;
                            case 'int':
                                if (!filter_var($value, FILTER_VALIDATE_INT)) {
                                    $errors[$field][] = "$field must be an integer";
                                }
                                break;
                        }
                    }
                    
                    // 长度验证
                    if (isset($rule['min_length']) && strlen($value) < $rule['min_length']) {
                        $errors[$field][] = "$field must be at least {$rule['min_length']} characters";
                    }
                    
                    if (isset($rule['max_length']) && strlen($value) > $rule['max_length']) {
                        $errors[$field][] = "$field must be at most {$rule['max_length']} characters";
                    }
                }
            }
            
            return [
                'valid' => empty($errors),
                'errors' => $errors
            ];
        };
    }
    
    // 创建用户注册验证器
    $userValidator = createValidator([
        'username' => [
            'required' => true,
            'min_length' => 3,
            'max_length' => 20
        ],
        'email' => [
            'required' => true,
            'type' => 'email'
        ],
        'age' => [
            'required' => false,
            'type' => 'int'
        ]
    ]);
    
    // 验证用户数据
    $userData = [
        'username' => 'alice',
        'email' => 'alice@example.com',
        'age' => '25'
    ];
    
    $validation = $userValidator($userData);
    
    if ($validation['valid']) {
        echo "用户数据验证通过\n";
    } else {
        echo "验证失败:\n";
        print_r($validation['errors']);
    }
?>
```

## 七、回调函数

### 7.1 回调函数基础

回调函数是作为参数传递给其他函数的函数，在特定时机被调用：

```php
<?php
    // 简单的回调示例
    function processData($data, $callback) {
        $processed = [];
        foreach ($data as $item) {
            $processed[] = $callback($item);
        }
        return $processed;
    }
    
    // 使用函数名作为回调
    function doubleValue($x) {
        return $x * 2;
    }
    
    $numbers = [1, 2, 3, 4, 5];
    $doubled = processData($numbers, 'doubleValue');
    print_r($doubled); // [2, 4, 6, 8, 10]
    
    // 使用匿名函数作为回调
    $squared = processData($numbers, function($x) {
        return $x * $x;
    });
    print_r($squared); // [1, 4, 9, 16, 25]
?>
```

### 7.2 安全的回调函数应用

```php
<?php
    // 安全的事件处理系统
    class SecurityEventHandler {
        private $handlers = [];
        
        public function on($event, $callback) {
            // 验证回调函数
            if (!is_callable($callback)) {
                throw new InvalidArgumentException('Callback must be callable');
            }
            
            if (!isset($this->handlers[$event])) {
                $this->handlers[$event] = [];
            }
            
            $this->handlers[$event][] = $callback;
        }
        
        public function emit($event, $data = []) {
            if (!isset($this->handlers[$event])) {
                return;
            }
            
            foreach ($this->handlers[$event] as $handler) {
                try {
                    call_user_func($handler, $data);
                } catch (Exception $e) {
                    error_log("Event handler error: " . $e->getMessage());
                }
            }
        }
    }
    
    // 使用示例
    $eventHandler = new SecurityEventHandler();
    
    // 注册事件处理器
    $eventHandler->on('user_login', function($data) {
        error_log("用户登录: " . $data['username'] . " IP: " . $data['ip']);
    });
    
    $eventHandler->on('user_login', function($data) {
        // 检查可疑登录
        if ($data['failed_attempts'] > 3) {
            error_log("可疑登录尝试: " . $data['username']);
        }
    });
    
    $eventHandler->on('security_breach', function($data) {
        // 发送安全警报
        mail('security@example.com', '安全警报', $data['message']);
    });
    
    // 触发事件
    $eventHandler->emit('user_login', [
        'username' => 'alice',
        'ip' => '192.168.1.100',
        'failed_attempts' => 0
    ]);
?>
```

### 7.3 内置回调函数的安全使用

```php
<?php
    // 安全使用array_walk处理敏感数据
    function sanitizeUserData($userData) {
        $sanitized = $userData;
        
        // 定义不同字段的处理规则
        $sanitizers = [
            'email' => function(&$value) {
                $value = filter_var($value, FILTER_SANITIZE_EMAIL);
            },
            'name' => function(&$value) {
                $value = htmlspecialchars(trim($value), ENT_QUOTES, 'UTF-8');
            },
            'phone' => function(&$value) {
                $value = preg_replace('/[^0-9+\-()]/', '', $value);
            },
            'default' => function(&$value) {
                if (is_string($value)) {
                    $value = htmlspecialchars(trim($value), ENT_QUOTES, 'UTF-8');
                }
            }
        ];
        
        array_walk($sanitized, function(&$value, $key) use ($sanitizers) {
            $sanitizer = $sanitizers[$key] ?? $sanitizers['default'];
            $sanitizer($value);
        });
        
        return $sanitized;
    }
    
    // 使用示例
    $rawUserData = [
        'name' => '  <script>alert("XSS")</script>Alice  ',
        'email' => 'alice@example.com',
        'phone' => '123-456-7890 ext',
        'bio' => '<img src=x onerror=alert(1)>'
    ];
    
    $cleanData = sanitizeUserData($rawUserData);
    print_r($cleanData);
?>
```

## 八、PHP变量作用域

### 8.1 作用域类型

PHP中的变量作用域决定了变量在代码中的可见性和生命周期：

```php
<?php
    // 全局作用域
    $globalVar = "我是全局变量";
    
    function demonstrateScope() {
        // 局部作用域
        $localVar = "我是局部变量";
        
        // 访问全局变量需要使用global关键字
        global $globalVar;
        echo $globalVar . "\n";
        
        // 静态变量
        static $staticVar = 0;
        $staticVar++;
        echo "静态变量调用次数: $staticVar\n";
        
        return $localVar;
    }
    
    echo demonstrateScope(); // 第一次调用
    echo demonstrateScope(); // 第二次调用
    
    // $localVar 在这里不可访问
    // echo $localVar; // 这会产生错误
?>
```

### 8.2 超全局变量

PHP提供了几个超全局变量，它们在任何作用域中都可以直接访问：

```php
<?php
    // 安全处理超全局变量的函数
    class SecureGlobals {
        
        // 安全获取GET参数
        public static function getParam($key, $default = null, $type = 'string') {
            if (!isset($_GET[$key])) {
                return $default;
            }
            
            return self::sanitizeInput($_GET[$key], $type);
        }
        
        // 安全获取POST参数
        public static function postParam($key, $default = null, $type = 'string') {
            if (!isset($_POST[$key])) {
                return $default;
            }
            
            return self::sanitizeInput($_POST[$key], $type);
        }
        
        // 安全获取SESSION数据
        public static function sessionGet($key, $default = null) {
            if (!isset($_SESSION)) {
                session_start();
            }
            
            return $_SESSION[$key] ?? $default;
        }
        
        // 安全设置SESSION数据
        public static function sessionSet($key, $value) {
            if (!isset($_SESSION)) {
                session_start();
            }
            
            $_SESSION[$key] = $value;
        }
        
        // 输入清理函数
        private static function sanitizeInput($input, $type) {
            switch ($type) {
                case 'int':
                    return filter_var($input, FILTER_VALIDATE_INT);
                case 'float':
                    return filter_var($input, FILTER_VALIDATE_FLOAT);
                case 'email':
                    return filter_var($input, FILTER_VALIDATE_EMAIL);
                case 'url':
                    return filter_var($input, FILTER_VALIDATE_URL);
                case 'string':
                default:
                    return htmlspecialchars(trim($input), ENT_QUOTES, 'UTF-8');
            }
        }
        
        // 获取客户端IP地址
        public static function getClientIP() {
            $ipKeys = ['HTTP_X_FORWARDED_FOR', 'HTTP_X_REAL_IP', 'HTTP_CLIENT_IP', 'REMOTE_ADDR'];
            
            foreach ($ipKeys as $key) {
                if (!empty($_SERVER[$key])) {
                    $ips = explode(',', $_SERVER[$key]);
                    $ip = trim($ips[0]);
                    
                    if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) {
                        return $ip;
                    }
                }
            }
            
            return $_SERVER['REMOTE_ADDR'] ?? 'unknown';
        }
    }
    
    // 使用示例
    $userId = SecureGlobals::getParam('user_id', 0, 'int');
    $searchQuery = SecureGlobals::getParam('q', '', 'string');
    $email = SecureGlobals::postParam('email', '', 'email');
    $currentUser = SecureGlobals::sessionGet('user', null);
    $clientIP = SecureGlobals::getClientIP();
    
    echo "User ID: $userId\n";
    echo "Search Query: $searchQuery\n";
    echo "Email: $email\n";
    echo "Client IP: $clientIP\n";
?>
```

### 8.3 作用域安全最佳实践

```php
<?php
    // 安全的配置管理类
    class SecureConfig {
        private static $config = [];
        private static $initialized = false;
        
        // 私有构造函数防止实例化
        private function __construct() {}
        
        // 初始化配置
        public static function init($configFile) {
            if (self::$initialized) {
                return;
            }
            
            if (!file_exists($configFile) || !is_readable($configFile)) {
                throw new Exception('配置文件不存在或不可读');
            }
            
            $config = include $configFile;
            
            if (!is_array($config)) {
                throw new Exception('配置文件格式错误');
            }
            
            self::$config = $config;
            self::$initialized = true;
        }
        
        // 安全获取配置值
        public static function get($key, $default = null) {
            if (!self::$initialized) {
                throw new Exception('配置未初始化');
            }
            
            $keys = explode('.', $key);
            $value = self::$config;
            
            foreach ($keys as $k) {
                if (!is_array($value) || !array_key_exists($k, $value)) {
                    return $default;
                }
                $value = $value[$k];
            }
            
            return $value;
        }
        
        // 防止配置被外部修改
        public static function set($key, $value) {
            throw new Exception('配置为只读，不允许动态修改');
        }
    }
    
    // 安全的数据库连接管理
    class DatabaseManager {
        private static $connections = [];
        
        public static function connect($name = 'default') {
            if (isset(self::$connections[$name])) {
                return self::$connections[$name];
            }
            
            $config = SecureConfig::get("database.{$name}");
            
            if (!$config) {
                throw new Exception("数据库配置 '{$name}' 不存在");
            }
            
            try {
                $dsn = "mysql:host={$config['host']};dbname={$config['database']};charset=utf8mb4";
                $pdo = new PDO($dsn, $config['username'], $config['password'], [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false,
                ]);
                
                self::$connections[$name] = $pdo;
                return $pdo;
            } catch (PDOException $e) {
                error_log("数据库连接失败: " . $e->getMessage());
                throw new Exception('数据库连接失败');
            }
        }
    }
?>
```

## 九、基础实验：PHP函数综合应用

### 9.1 实验目标

通过实际项目演练，掌握PHP函数的各种特性和安全编程实践。

### 9.2 实验项目：安全的用户管理系统

创建一个完整的用户管理系统，包含用户注册、登录、权限验证等功能：

```php
<?php
// config.php - 配置文件
return [
    'database' => [
        'default' => [
            'host' => 'localhost',
            'database' => 'user_management',
            'username' => 'root',
            'password' => 'password'
        ]
    ],
    'security' => [
        'password_min_length' => 8,
        'max_login_attempts' => 5,
        'session_timeout' => 3600
    ]
];
?>
```

```php
<?php
// user_management_system.php - 主系统文件
session_start();

// 包含配置和类定义
require_once 'config.php';

// 初始化配置
SecureConfig::init('config.php');

// 用户管理类
class UserManager {
    private $db;
    
    public function __construct() {
        $this->db = DatabaseManager::connect();
    }
    
    // 用户注册
    public function register($userData, $validationCallback = null) {
        try {
            // 默认验证回调
            $defaultValidation = function($data) {
                $errors = [];
                
                if (empty($data['username']) || strlen($data['username']) < 3) {
                    $errors[] = '用户名至少3个字符';
                }
                
                if (empty($data['email']) || !filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
                    $errors[] = '请输入有效邮箱地址';
                }
                
                if (empty($data['password']) || strlen($data['password']) < 8) {
                    $errors[] = '密码至少8个字符';
                }
                
                return $errors;
            };
            
            $validator = $validationCallback ?: $defaultValidation;
            $errors = $validator($userData);
            
            if (!empty($errors)) {
                return ['success' => false, 'errors' => $errors];
            }
            
            // 检查用户名是否已存在
            if ($this->userExists($userData['username'], $userData['email'])) {
                return ['success' => false, 'errors' => ['用户名或邮箱已存在']];
            }
            
            // 创建用户
            $hashedPassword = password_hash($userData['password'], PASSWORD_DEFAULT);
            
            $stmt = $this->db->prepare("
                INSERT INTO users (username, email, password_hash, created_at) 
                VALUES (?, ?, ?, NOW())
            ");
            
            $stmt->execute([
                $userData['username'],
                $userData['email'],
                $hashedPassword
            ]);
            
            return ['success' => true, 'message' => '用户注册成功'];
            
        } catch (Exception $e) {
            error_log("用户注册失败: " . $e->getMessage());
            return ['success' => false, 'errors' => ['注册失败，请稍后重试']];
        }
    }
    
    // 用户登录
    public function login($username, $password, $rememberMe = false) {
        try {
            // 检查登录尝试次数
            $attempts = $this->getLoginAttempts($username);
            $maxAttempts = SecureConfig::get('security.max_login_attempts', 5);
            
            if ($attempts >= $maxAttempts) {
                return ['success' => false, 'message' => '登录尝试次数过多，请稍后再试'];
            }
            
            // 查找用户
            $stmt = $this->db->prepare("SELECT id, username, email, password_hash FROM users WHERE username = ? OR email = ?");
            $stmt->execute([$username, $username]);
            $user = $stmt->fetch();
            
            if (!$user || !password_verify($password, $user['password_hash'])) {
                $this->recordLoginAttempt($username, false);
                return ['success' => false, 'message' => '用户名或密码错误'];
            }
            
            // 登录成功
            $this->recordLoginAttempt($username, true);
            $this->createSession($user, $rememberMe);
            
            return [
                'success' => true,
                'message' => '登录成功',
                'user' => [
                    'id' => $user['id'],
                    'username' => $user['username'],
                    'email' => $user['email']
                ]
            ];
            
        } catch (Exception $e) {
            error_log("用户登录失败: " . $e->getMessage());
            return ['success' => false, 'message' => '登录失败，请稍后重试'];
        }
    }
    
    // 检查用户是否存在
    private function userExists($username, $email) {
        $stmt = $this->db->prepare("SELECT COUNT(*) FROM users WHERE username = ? OR email = ?");
        $stmt->execute([$username, $email]);
        return $stmt->fetchColumn() > 0;
    }
    
    // 获取登录尝试次数
    private function getLoginAttempts($username) {
        $stmt = $this->db->prepare("
            SELECT COUNT(*) FROM login_attempts 
            WHERE username = ? AND success = 0 AND attempt_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
        ");
        $stmt->execute([$username]);
        return $stmt->fetchColumn();
    }
    
    // 记录登录尝试
    private function recordLoginAttempt($username, $success) {
        $stmt = $this->db->prepare("
            INSERT INTO login_attempts (username, success, ip_address, attempt_time) 
            VALUES (?, ?, ?, NOW())
        ");
        $stmt->execute([$username, $success ? 1 : 0, $_SERVER['REMOTE_ADDR']]);
    }
    
    // 创建会话
    private function createSession($user, $rememberMe) {
        session_regenerate_id(true);
        
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['login_time'] = time();
        $_SESSION['last_activity'] = time();
        
        if ($rememberMe) {
            $token = bin2hex(random_bytes(32));
            setcookie('remember_token', $token, time() + (30 * 24 * 60 * 60)); // 30天
            
            // 将记住密码令牌存储到数据库
            $stmt = $this->db->prepare("
                UPDATE users SET remember_token = ?, remember_token_expires = DATE_ADD(NOW(), INTERVAL 30 DAY) 
                WHERE id = ?
            ");
            $stmt->execute([$token, $user['id']]);
        }
    }
}

// 权限验证功能
class AuthManager {
    
    // 检查用户是否已登录
    public static function isLoggedIn() {
        if (!isset($_SESSION['user_id'])) {
            return false;
        }
        
        // 检查会话超时
        $timeout = SecureConfig::get('security.session_timeout', 3600);
        if (time() - $_SESSION['last_activity'] > $timeout) {
            self::logout();
            return false;
        }
        
        $_SESSION['last_activity'] = time();
        return true;
    }
    
    // 注销用户
    public static function logout() {
        $_SESSION = [];
        
        if (ini_get("session.use_cookies")) {
            $params = session_get_cookie_params();
            setcookie(session_name(), '', time() - 42000,
                $params["path"], $params["domain"],
                $params["secure"], $params["httponly"]
            );
        }
        
        // 清除记住密码cookie
        if (isset($_COOKIE['remember_token'])) {
            setcookie('remember_token', '', time() - 42000);
        }
        
        session_destroy();
    }
    
    // 要求用户登录
    public static function requireLogin() {
        if (!self::isLoggedIn()) {
            header('Location: login.php');
            exit;
        }
    }
}

// 页面处理逻辑
$action = $_POST['action'] ?? $_GET['action'] ?? 'show_form';
$userManager = new UserManager();
$message = '';

if ($action === 'register' && $_SERVER['REQUEST_METHOD'] === 'POST') {
    $userData = [
        'username' => SecureGlobals::postParam('username', '', 'string'),
        'email' => SecureGlobals::postParam('email', '', 'email'),
        'password' => $_POST['password'] ?? ''
    ];
    
    $result = $userManager->register($userData);
    
    if ($result['success']) {
        $message = '<div class="success">' . $result['message'] . '</div>';
    } else {
        $message = '<div class="error">' . implode('<br>', $result['errors']) . '</div>';
    }
} elseif ($action === 'login' && $_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = SecureGlobals::postParam('username', '', 'string');
    $password = $_POST['password'] ?? '';
    $rememberMe = isset($_POST['remember_me']);
    
    $result = $userManager->login($username, $password, $rememberMe);
    
    if ($result['success']) {
        header('Location: dashboard.php');
        exit;
    } else {
        $message = '<div class="error">' . $result['message'] . '</div>';
    }
} elseif ($action === 'logout') {
    AuthManager::logout();
    header('Location: login.php');
    exit;
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>PHP函数实验 - 用户管理系统</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: green; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; margin: 15px 0; }
        .error { color: red; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; margin: 15px 0; }
        .tabs { margin-bottom: 20px; }
        .tab { display: inline-block; padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <h1>PHP函数实验 - 用户管理系统</h1>
    
    <?= $message ?>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('register')">用户注册</div>
        <div class="tab" onclick="showTab('login')">用户登录</div>
        <div class="tab" onclick="showTab('info')">系统信息</div>
    </div>
    
    <!-- 注册表单 -->
    <div id="register" class="tab-content active">
        <h2>用户注册</h2>
        <form method="POST">
            <input type="hidden" name="action" value="register">
            
            <div class="form-group">
                <label>用户名：</label>
                <input type="text" name="username" required minlength="3" maxlength="20">
            </div>
            
            <div class="form-group">
                <label>邮箱：</label>
                <input type="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label>密码：</label>
                <input type="password" name="password" required minlength="8">
            </div>
            
            <button type="submit">注册</button>
        </form>
    </div>
    
    <!-- 登录表单 -->
    <div id="login" class="tab-content">
        <h2>用户登录</h2>
        <form method="POST">
            <input type="hidden" name="action" value="login">
            
            <div class="form-group">
                <label>用户名或邮箱：</label>
                <input type="text" name="username" required>
            </div>
            
            <div class="form-group">
                <label>密码：</label>
                <input type="password" name="password" required>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="remember_me"> 记住我（30天）
                </label>
            </div>
            
            <button type="submit">登录</button>
        </form>
    </div>
    
    <!-- 系统信息 -->
    <div id="info" class="tab-content">
        <h2>系统信息</h2>
        <h3>本实验演示的PHP函数特性：</h3>
        <ul>
            <li>✅ 用户定义函数（register、login等）</li>
            <li>✅ 函数参数（必需参数、可选参数）</li>
            <li>✅ 默认参数（验证配置、超时设置）</li>
            <li>✅ 函数返回值（状态数组）</li>
            <li>✅ 匿名函数（数据验证回调）</li>
            <li>✅ 回调函数（自定义验证器）</li>
            <li>✅ 变量作用域（类属性、静态方法）</li>
        </ul>
        
        <h3>安全特性：</h3>
        <ul>
            <li>密码哈希存储</li>
            <li>登录尝试次数限制</li>
            <li>会话超时管理</li>
            <li>输入验证和过滤</li>
            <li>SQL注入防护</li>
            <li>XSS防护</li>
            <li>CSRF防护（会话令牌）</li>
        </ul>
        
        <h3>当前PHP环境：</h3>
        <p>PHP版本：<?= PHP_VERSION ?></p>
        <p>服务器软件：<?= $_SERVER['SERVER_SOFTWARE'] ?? 'Unknown' ?></p>
        <p>客户端IP：<?= SecureGlobals::getClientIP() ?></p>
    </div>
    
    <script>
        function showTab(tabName) {
            // 隐藏所有标签内容
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // 移除所有标签的active类
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
```

### 9.3 数据库表结构

```sql
-- 创建用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    remember_token VARCHAR(64),
    remember_token_expires DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建登录尝试记录表
CREATE TABLE login_attempts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    success BOOLEAN NOT NULL,
    ip_address VARCHAR(45),
    attempt_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 十、课程总结

### 10.1 本章知识点回顾

| 知识模块 | 核心内容 | 安全要点 |
|----------|----------|----------|
| **用户定义函数** | 函数定义、命名规范、安全设计 | 输入验证、错误处理、明确的函数职责 |
| **函数参数** | 值传递、引用传递、类型声明 | 参数验证、类型安全、防止参数污染 |
| **默认参数** | 默认值设置、参数顺序 | 安全的默认值、避免敏感信息泄露 |
| **函数返回值** | 返回类型、错误处理 | 统一的返回格式、异常处理机制 |
| **匿名函数** | 闭包语法、变量捕获 | 作用域安全、防止变量泄露 |
| **回调函数** | 回调机制、事件处理 | 回调验证、防止任意代码执行 |
| **变量作用域** | 全局、局部、静态、超全局 | 最小权限原则、避免全局污染 |

### 10.2 安全编程最佳实践

1. **函数设计原则**
   - 单一职责：每个函数只做一件事
   - 输入验证：永远不要信任外部输入
   - 输出安全：正确编码输出数据
   - 错误处理：优雅处理各种异常情况

2. **参数安全**
   - 使用类型声明增强安全性
   - 验证参数的范围和格式
   - 避免使用全局变量传递敏感数据
   - 清理和验证所有外部输入

3. **作用域管理**
   - 最小化变量作用域
   - 避免全局变量的滥用
   - 正确处理超全局变量
   - 使用静态变量时注意线程安全

### 10.3 下一步学习方向

完成PHP函数学习后，接下来将学习：
1. **PHP类与对象** - 面向对象编程基础
2. **PHP正则表达式** - 模式匹配和数据验证  
3. **PHP调用MySQL** - 数据库操作和安全

通过本章学习，你已经掌握了PHP函数的核心知识和安全编程实践，为构建安全可靠的Web应用打下了坚实基础。