# 05.诸神之眼——nmap

## 1. Nmap 简介
- **Nmap（Network Mapper）** 是一款开源的网络扫描与安全审计工具  ，是安全从业者最常用的端口扫描工具（图形化版本Zenmap）
- 主要用途：
  - 主机发现（Host Discovery）
  - 端口扫描（Port Scanning）
  - 服务与版本探测（Service/Version Detection）
  - 操作系统识别（OS Detection）
  - 防火墙/IDS规避测试
- 常见应用：
  - 管理员：检查网络资产与端口暴露情况
  - 渗透测试人员：信息收集、渗透测试前期打点
  - 安全研究员：批量探测服务漏洞

---

## 2. 为什么要学 Nmap？
- 渗透测试第一步：信息收集
- 目标：**找到活跃主机 → 探测开放端口 → 确认运行服务 → 分析潜在漏洞**
- Nmap 的优势：
  - 免费、开源
  - 功能全面
  - 社区支持强大

---

## 3. 目标设定 —— 扫描对象
- 单一主机：  
  ```bash
  nmap 192.168.1.1

- 多个主机：

  ```bash
  nmap 192.168.1.1 192.168.1.2
  ```

- 网段：

  ```bash
  nmap 192.168.1.0/24
  ```

- 从文件读取：

  ```bash
  nmap -iL targets.txt
  ```

------

## 4. 主机发现 —— 探测在线主机

- 默认探测：ICMP + TCP 探测

- 常用参数：

  - `-sn`：仅探测主机存活，不扫描端口
  - `-Pn`：跳过主机发现（适合禁 Ping 环境）

- 示例：

  ```bash
  nmap -sn 192.168.1.0/24
  ```

------

## 5. 端口扫描 —— 探测在线主机开放了哪些服务

- **端口的作用**：服务入口，如 80 → Web，22 → SSH

- Nmap 常用扫描方式：

  - **TCP Connect 扫描（-sT）**：最稳定，容易被发现
  - **SYN 扫描（-sS）**：常用，隐蔽性强
  - **UDP 扫描（-sU）**：探测无连接服务（如 DNS）

- 自定义端口范围：

  ```bash
  nmap -p 80,443,3306 192.168.1.1
  nmap -p 1-65535 192.168.1.1
  ```

------

## 6. 端口状态解读

- **open**：端口开放，有服务响应
- **closed**：端口关闭，但可达
- **filtered**：端口被防火墙过滤
- **unfiltered**：可访问但无法确定
- **open|filtered**：不确定是否开放

------

## 7. 服务与版本识别

- 命令：

  ```bash
  nmap -sV 192.168.1.1
  ```

- 作用：识别端口上的具体服务及版本

- 应用：判断是否存在已知漏洞（如特定版本的 Apache）

------

## 8. 操作系统识别

- 命令：

  ```bash
  nmap -O 192.168.1.1
  ```

- 功能：猜测目标操作系统类型（Linux/Windows）

- 注意：准确率受限，需结合其他手段验证

------

## 9. Nmap 脚本引擎（NSE）

- 功能：扩展性极强，可自动化探测漏洞

- 脚本分类：

  - **discovery**（信息收集）
  - **vuln**（漏洞探测）
  - **brute**（暴力破解）

- 示例：

  ```bash
  nmap --script=vuln 192.168.1.1
  nmap --script=http-title 192.168.1.1
  ```

------

## 10. 输出结果管理

- 普通输出：`-oN result.txt`
- XML 输出：`-oX result.xml`
- Grep 输出：`-oG result.gnmap`

------

## 11. 时间与性能优化

- 扫描速度控制：
  - `-T0`：极慢，规避检测
  - `-T3`：默认
  - `-T5`：极快，风险高
- 高级选项：
  - `--min-rate`：最小发送速率
  - `--max-rate`：最大发送速率

------

## 12. 防火墙/IDS 规避与欺骗

- 常见技巧：
  - 源 IP 欺骗：`--source-ip`
  - MAC 地址伪造：`--spoof-mac`
  - 数据包分片：`-f`
  - 延迟发送：`--scan-delay`
- 目的：绕过安全设备检测，增加扫描隐蔽性

------

## 13. Nmap 实战演练

1. **存活探测**

   ```bash
   nmap -sn 192.168.1.100
   ```

2. **快速端口扫描**

   ```bash
   nmap -F 192.168.1.100
   ```

3. **全端口 + 服务识别**

   ```bash
   nmap -sS -sV -p- 192.168.1.100
   ```

4. **漏洞探测脚本**

   ```bash
   nmap --script=vuln 192.168.1.100
   ```

## 14.附：Nmap常见参数表

| 分类           | 参数  | 含义                                            | 示例                                                     |
| :------------- | ----- | ----------------------------------------------- | -------------------------------------------------------- |
| **基本参数  ** | `-v`  | 显示详细扫描过程（可重复使用，如 `-vv` 更详细） | `nmap -v 192.168.1.1`                                    |
|                | `-oN` | 输出到普通文本文件                              | `nmap -oN result.txt 192.168.1.1`                        |
|                | `-oX` | 输出到 XML 文件                                 | `nmap -oX result.xml 192.168.1.1`                        |
|                | `-oG` | 输出为 Grep 格式                                | `nmap -oG result.gnmap 192.168.1.1`                      |
|                | `-iL` | 从文件读取目标                                  | `nmap -iL targets.txt`                                   |
|                | `-p`  | 指定端口或端口范围                              | `nmap -p 22,80,443 192.168.1.1` / `nmap -p- 192.168.1.1` |

| 分类         | 参数  | 含义                              | 示例                           |
| ------------ | ----- | --------------------------------- | ------------------------------ |
| **主机发现** | `-sn` | Ping 扫描（仅探测存活，不扫端口） | `nmap -sn 192.168.1.0/24`      |
|              | `-Pn` | 跳过主机发现，直接扫描            | `nmap -Pn 192.168.1.1`         |
|              | `-PS` | 使用 TCP SYN Ping                 | `nmap -PS80,443 192.168.1.1`   |
|              | `-PA` | 使用 TCP ACK Ping                 | `nmap -PA21,22,80 192.168.1.1` |
|              | `-PE` | 使用 ICMP Echo Ping               | `nmap -PE 192.168.1.1`         |
|              | `-PP` | 使用 ICMP Timestamp Ping          | `nmap -PP 192.168.1.1`         |

| 分类         | 参数  | 含义                           | 示例                   |
| ------------ | ----- | ------------------------------ | ---------------------- |
| **扫描方式** | `-sS` | SYN 半开扫描（默认，隐蔽性强） | `nmap -sS 192.168.1.1` |
|              | `-sT` | TCP 全连接扫描                 | `nmap -sT 192.168.1.1` |
|              | `-sU` | UDP 扫描                       | `nmap -sU 192.168.1.1` |
|              | `-sA` | TCP ACK 扫描（探测防火墙规则） | `nmap -sA 192.168.1.1` |
|              | `-sW` | TCP 窗口扫描                   | `nmap -sW 192.168.1.1` |
|              | `-sM` | TCP Maimon 扫描                | `nmap -sM 192.168.1.1` |
|              | `-sN` | TCP Null 扫描                  | `nmap -sN 192.168.1.1` |
|              | `-sF` | TCP FIN 扫描                   | `nmap -sF 192.168.1.1` |
|              | `-sX` | Xmas 扫描（FIN+URG+PSH）       | `nmap -sX 192.168.1.1` |

| 分类              | 参数                  | 含义                           | 示例                                         |
| ----------------- | --------------------- | ------------------------------ | -------------------------------------------- |
| **服务/系统检测** | `-sV`                 | 探测服务与版本                 | `nmap -sV 192.168.1.1`                       |
|                   | `--version-intensity` | 控制服务检测强度（0–9）        | `nmap -sV --version-intensity 9 192.168.1.1` |
|                   | `-O`                  | 操作系统检测                   | `nmap -O 192.168.1.1`                        |
|                   | `--osscan-limit`      | 只对可能识别的主机进行 OS 扫描 | `nmap -O --osscan-limit 192.168.1.1`         |
|                   | `--osscan-guess`      | 强制猜测操作系统               | `nmap -O --osscan-guess 192.168.1.1`         |

| 分类               | 参数            | 含义           | 示例                                                         |
| ------------------ | --------------- | -------------- | ------------------------------------------------------------ |
| **脚本引擎 (NSE)** | `--script`      | 指定使用脚本   | `nmap --script=vuln 192.168.1.1`                             |
|                    | `--script-help` | 查看脚本说明   | `nmap --script-help=http-title`                              |
|                    | `--script-args` | 给脚本传递参数 | `nmap --script=http-brute --script-args userdb=users.txt,passdb=pass.txt` |

| 分类           | 参数           | 含义                       | 示例                               |
| -------------- | -------------- | -------------------------- | ---------------------------------- |
| **时间与性能** | `-T<0-5>`      | 时间模板，控制速度与隐蔽性 | `nmap -T4 192.168.1.1`             |
|                | `--min-rate`   | 设置最小包发送速率         | `nmap --min-rate 1000 192.168.1.1` |
|                | `--max-rate`   | 设置最大发送速率           | `nmap --max-rate 100 192.168.1.1`  |
|                | `--scan-delay` | 每次探测之间的延时         | `nmap --scan-delay 1s 192.168.1.1` |

| 分类                | 参数            | 含义                              | 示例                                   |
| ------------------- | --------------- | --------------------------------- | -------------------------------------- |
| **防火墙/IDS 规避** | `-f`            | 分片扫描包（规避检测）            | `nmap -f 192.168.1.1`                  |
|                     | `--mtu`         | 设置数据包大小（必须为 8 的倍数） | `nmap --mtu 24 192.168.1.1`            |
|                     | `--source-port` | 伪造源端口                        | `nmap --source-port 53 192.168.1.1`    |
|                     | `--source-ip`   | 伪造源 IP 地址                    | `nmap --source-ip 1.2.3.4 192.168.1.1` |
|                     | `--spoof-mac`   | 伪造 MAC 地址                     | `nmap --spoof-mac 0 192.168.1.1`       |

- **渗透测试常用组合**：  
  ```bash
  nmap -sS -sV -O -p- --script=vuln 192.168.1.100